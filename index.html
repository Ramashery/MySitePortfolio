<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft | Portfolio</title>
    <meta name="description" content="Professional websites for small businesses">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Three.js (asynchronous loading for better performance) -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* --- Global Variables --- */
        :root {
            --color-bg: #030409;
            --color-text: #FFFFFF; 
            --color-accent: #b8d8e8;
            --color-card: rgba(25, 29, 45, 0.4);
            --color-border: rgba(184, 216, 232, 0.2);
            --font-main: 'Cormorant Garamond', serif;
            --header-height: 80px;
        }

        /* --- Base Styles --- */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        a {
            color: var(--color-accent);
            text-decoration: none;
        }

        /* --- Preloader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-bg); display: flex; justify-content: center;
            align-items: center; z-index: 10000; transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--color-accent);
            border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Crystal Canvas --- */
        #webgl-canvas {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh; z-index: -1; /* Placed behind everything */
        }

        /* --- Main content --- */
        main {
            position: relative; z-index: 2; /* Main content above canvas */
            max-width: 1200px;
            margin: 0 auto; padding: 100px 30px;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        /* When modal or nav is open, main content should fade out and be unclickable */
        body.modal-is-open main, body.nav-is-open main {
            opacity: 0; transform: translateY(20px); pointer-events: none;
        }

        /* --- Animation System --- */
        section { margin-bottom: 120px; perspective: 1000px; } /* perspective for 3D transforms */
        .animated-container {
            opacity: 0; transform: translateX(-30px) rotate(-5deg);
            transition: all 0.7s cubic-bezier(0.2, 0.9, 0.3, 1.1);
        }
        .animated-container.active { opacity: 1; transform: none; }
        @keyframes letterAppear {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: none; }
        }
        .animated-text { color: transparent; } /* Hide text by default for letter animation */
        .animated-text.is-animating { color: initial; } /* Show text when animating */
        .animated-text span {
            display: inline-block; opacity: 0;
            animation: letterAppear 0.5s forwards;
        }

        /* --- Generic Cards --- */
        .item-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-top: 40px;
        }
        .item-card {
            background: var(--color-card); border: 1px solid var(--color-border);
            border-radius: 8px; overflow: hidden; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .item-card:hover {
            transform: translateY(-10px) scale(1.02) !important;
            border-color: var(--color-accent); box-shadow: 0 10px 30px rgba(184, 216, 232, 0.3);
        }
        .item-card__image {
            height: 200px; 
            /* Default fallback gradient if no image is set */
            background: linear-gradient(135deg, rgba(184, 216, 232, 0.1), rgba(25, 29, 45, 0.7));
            background-size: cover; background-position: center;
            opacity: 1; transition: opacity 0.5s ease-in-out;
        }
        .item-card__content { padding: 25px; }
        .item-card h3 { margin: 0 0 10px; font-size: 1.5rem; transition: color 0.3s ease-out; }
        .item-card:hover h3 { color: var(--color-accent); }
        .item-card .card-subtitle { display: block; margin-bottom: 15px; opacity: 0.8; font-size: 0.9rem; }
        .item-card p { margin: 0; opacity: 0.9; }

        /* --- Modern Menu Toggle Button --- */
        .menu-toggle {
            position: fixed; top: 30px; right: 30px; z-index: 1002; /* Above everything else */
            background: transparent; border: none; padding: 0; cursor: pointer;
            width: 30px; height: 24px; display: flex; flex-direction: column;
            justify-content: space-between; transition: transform 0.4s;
        }
        .menu-toggle:hover { transform: scale(1.1); }
        .menu-toggle .bar { background: var(--color-text); height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        
        /* --- Nav Menu Overlay --- */
        .nav-overlay {
            position: fixed; top: 0; right: -100%; width: 400px; height: 100vh;
            /* Changed background to be semi-transparent with blur for better readability */
            background: rgba(3, 4, 9, 0.95); /* Adjusted for better visibility */
            backdrop-filter: blur(15px); /* Added blur for modern look */
            -webkit-backdrop-filter: blur(15px);
            z-index: 999; /* Below toggle, above main content */
            transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); overflow: hidden;
        }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; margin: 0; }
        .nav-menu li { margin-bottom: 25px; opacity: 0; transform: translateX(30px); transition: all 0.4s ease-out; }
        /* Staggered animation for menu items */
        .nav-overlay.is-active .nav-menu li { opacity: 1; transform: translateX(0); }
        .nav-menu li:nth-child(1) { transition-delay: 0.1s; } .nav-menu li:nth-child(2) { transition-delay: 0.2s; }
        .nav-menu li:nth-child(3) { transition-delay: 0.3s; } .nav-menu li:nth-child(4) { transition-delay: 0.4s; }
        .nav-menu li:nth-child(5) { transition-delay: 0.5s; } .nav-menu li:nth-child(6) { transition-delay: 0.6s; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; position: relative; padding-bottom: 5px; transition: all 0.3s ease-out; }
        .nav-menu a:hover { color: var(--color-accent); transform: translateX(5px); }
        .nav-menu a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: var(--color-accent); transition: width 0.4s; }
        .nav-menu a:hover::after { width: 100%; }

        /* --- Hero Section & CTA Buttons --- */
        .hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; }
        .hero h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0 0 20px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .hero p { font-size: 1.4rem; max-width: 600px; margin-bottom: 40px; }
        .hero-buttons { display: flex; gap: 20px; flex-wrap: wrap; }
        .cta-button {
            display: inline-block; padding: 14px 32px; text-decoration: none; font-weight: 600;
            font-size: 1rem; color: var(--color-text); border: 1px solid var(--color-accent);
            background-color: rgba(44, 75, 90, 0.3); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .cta-button:hover { transform: translateY(-5px) scale(1.05); border-color: var(--color-text); box-shadow: 0 5px 25px 5px rgba(184, 216, 232, 0.4); }

        /* --- Modal Windows --- */
        #modal-container { position: relative; z-index: 1001; } /* Above nav, below toggle/close btn */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s;
            /* Added backdrop blur for the whole modal overlay, outside the content */
            background: rgba(3, 4, 9, 0.5); /* Semi-transparent dark overlay for consistency */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal.is-active { opacity: 1; pointer-events: all; }
        
        .modal__content { 
            max-width: 800px; width: 90%; max-height: 85vh;
            overflow-y: auto; text-align: left; padding: 0; position: relative; 
            /* Changed from transparent to a semi-opaque background for visibility */
            background: rgba(25, 29, 45, 0.95); /* Much less transparent than before */
            border: 1px solid var(--color-border); /* Added border back for definition */
            border-radius: 8px; scrollbar-width: none;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); /* Added strong shadow for depth */
        }
        .modal__content::-webkit-scrollbar { display: none; }
        
        /* Modal Close Button */
        .modal__close {
            position: fixed; top: 30px; left: 30px; z-index: 1002; /* Same as menu toggle for consistency */
            background: transparent; border: none; padding: 0; cursor: pointer;
            width: 30px; height: 24px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s, transform 0.4s;
        }
        .modal__close.is-active { opacity: 1; pointer-events: all; }
        .modal__close:hover { transform: scale(1.1); }
        .modal__close .bar {
            background: var(--color-text); height: 2px; width: 100%; 
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            transform-origin: center;
            position: absolute; top: 50%;
        }
        .modal__close:hover .bar { background: var(--color-accent); }
        .modal__close .bar:nth-child(1) { transform: translateY(-1px) rotate(45deg); }
        .modal__close .bar:nth-child(2) { transform: translateY(1px) rotate(-45deg); }
        
        .modal__text-content {
             position: relative; z-index: 2; /* Text content above media viewer if present */
             padding: 40px;
             max-width: 650px; margin: 0 auto;
             background: transparent; /* Can be transparent now that modal__content has a solid background */
        }
        
        /* Ensure text shadow helps readability over modal backgrounds */
        .modal__content h2, .modal__content p, .modal-cta-container {
            text-shadow: 0 2px 15px rgba(0, 0, 0, 0.9);
        }

        .modal__content h2 { font-size: 2.5rem; margin-bottom: 20px; color: var(--color-accent); text-align: center; }
        .modal__content p { font-size: 1.2rem; line-height: 1.6; text-align: left; margin-bottom: 1em; }
        .modal-cta-container { margin-top: 40px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }

        .modal__media-viewer {
            position: sticky; top: 0; z-index: 1; /* Sticky effect for media */
            width: 100%; aspect-ratio: 16 / 9; /* Maintain aspect ratio */
            border-radius: 8px; /* Match modal border radius */
            touch-action: pan-y; /* Allows vertical scrolling but prevents horizontal in some cases */
            overflow: hidden;
            background-color: #000; /* Solid background for video/image before it loads */
        }
        .modal__media-viewer .media-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out;
            display: flex; justify-content: center; align-items: center;
        }
        .modal__media-viewer .media-item.is-active { opacity: 1; visibility: visible; }
        .modal__media-viewer img, .modal__media-viewer iframe { width: 100%; height: 100%; object-fit: cover; border: none; }

        /* --- Styles for Modal with iFrame Background (Matrix) --- */
        .modal.modal--has-iframe-bg {
            /* This modal overlay needs a slightly different approach for its background */
            background: rgba(0, 0, 0, 0.8); /* Darker, more immersive background for matrix */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal.modal--has-iframe-bg::before { /* This is an overlay for solid color */
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #000; 
            opacity: 0.8; /* Already had opacity here, useful for slight transparency */
            z-index: 0; /* Base layer for the background */
        }
        .modal.modal--has-iframe-bg .modal-bg-iframe { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1; /* iFrame should be above the `::before` overlay */
            border: none; opacity: 0.8; /* Maintain existing opacity */
        }
        .modal.modal--has-iframe-bg .modal__content { 
            /* This content is special: it aligns its text content centrally over the iframe background */
            max-height: 100vh; height: 100%; display: flex; align-items: center; justify-content: center; 
            background: transparent; /* Keep content transparent to show iframe background */
            border: none; /* No border for seamless integration */
            box-shadow: none; /* No shadow */
        }

        /* --- Admin Panel --- */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 4, 9, 0.95); z-index: 10000; display: none; overflow-y: auto; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        #admin-panel.active { display: block; }
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: rgba(25, 29, 45, 0.8); padding: 30px; border-right: 1px solid var(--color-border); position: sticky; top: 0; height: 100vh; }
        .admin-content { flex: 1; padding: 40px; }
        .admin-tabs { list-style: none; padding: 0; }
        .admin-tab { padding: 10px 0; cursor: pointer; transition: all 0.3s; }
        .admin-tab.active { color: var(--color-accent); font-weight: bold; }
        .admin-tab:not(.active):hover { color: var(--color-accent); transform: translateX(5px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #admin-close-btn { position: absolute; top: 25px; right: 25px; background: none; border: none; color: var(--color-text); font-size: 2rem; cursor: pointer; transition: all 0.3s; line-height: 1; }
        #admin-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .admin-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; margin-bottom: 30px; }
        .admin-item { background: var(--color-card); padding: 20px; border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 20px; }
        .admin-item-content { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .admin-item label { font-size: 0.9rem; opacity: 0.8; margin-bottom: -10px; }
        .admin-item input, .admin-item textarea { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--color-border); color: var(--color-text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 1rem; transition: all 0.3s; box-sizing: border-box; }
        .admin-item input:disabled, .admin-item textarea:disabled { background: transparent; border-color: transparent; color: var(--color-text); }
        .admin-item input:focus, .admin-item textarea:focus { border-color: var(--color-accent); background: rgba(0,0,0,0.4); }
        .admin-item textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        .admin-item-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .admin-btn { padding: 8px 16px; border: 1px solid var(--color-accent); background: rgba(184, 216, 232, 0.1); color: var(--color-accent); border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(184, 216, 232, 0.3); color: var(--color-text); }
        .admin-btn.delete-btn { border-color: #e57373; color: #e57373; }
        .admin-btn.delete-btn:hover { background: rgba(229, 115, 115, 0.3); color: var(--color-text); }
        .admin-btn.save-btn { display: none; }
        .admin-item.is-editing .edit-btn { display: none; }
        .admin-item.is-editing .save-btn { display: inline-block; }
        .admin-buttons-container { margin-top: 20px; border-top: 1px dashed var(--color-border); padding-top: 20px; }
        .admin-button-row { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .admin-button-row input { margin-bottom: 0; }
        .admin-button-row .delete-button-btn { height: 100%; }

        /* --- Reduced Motion & Responsive --- */
        @media (prefers-reduced-motion: reduce) { 
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } 
            .animated-container { opacity: 1; transform: none; transition: none; } 
            .animated-text span { opacity: 1; transform: none; animation: none; } 
        }
        @media (max-width: 768px) { 
            .animated-container { transform: translateX(-15px) rotate(-2deg); } 
            .nav-overlay { width: 100%; } 
            .hero h1 { font-size: 2.5rem; } 
            .item-grid { grid-template-columns: 1fr; } 
            .admin-container { flex-direction: column; } 
            .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-border); position: static; height: auto; } 
            .admin-content { padding: 20px; } 
            .modal__content { padding: 0; width: 100%; height: 100%; max-height: 100vh; border-radius: 0; border: none; } 
            .modal__text-content { padding: 20px; } 
            .modal__content h2 { font-size: 2rem; } 
            .modal__close { left: 20px; top: 20px; } 
        }
        @media (max-width: 480px) { 
            main { padding: 60px 15px; } 
            section { margin-bottom: 60px; } 
            .hero h1 { font-size: 2rem; } 
            .nav-menu { padding: 80px 20px; } 
            .nav-menu a { font-size: 1.5rem; } 
            .modal__close { left: 15px; top: 15px; } 
        }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <canvas id="webgl-canvas"></canvas>
    
    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    
    <button class="modal__close" aria-label="Close modal">
        <span class="bar"></span><span class="bar"></span>
    </button>

    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#contact">Contact</a></li>
            <li><a href="#" id="admin-toggle">Admin</a></li>
        </ul>
    </div>

    <main>
        <section id="hero" class="hero"></section>
        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
    </main>

    <div id="modal-container"></div>

    <div id="admin-panel">
        <div class="admin-container">
            <div class="admin-sidebar">
                <h3>Admin Panel</h3>
                <ul class="admin-tabs">
                    <li class="admin-tab active" data-tab="home">Home</li>
                    <li class="admin-tab" data-tab="services">Services</li>
                    <li class="admin-tab" data-tab="portfolio">Portfolio</li>
                    <li class="admin-tab" data-tab="blog">Blog</li>
                </ul>
            </div>
            <div class="admin-content">
                <button id="admin-close-btn" title="Close Admin Panel">&times;</button>
                <div class="tab-content active" data-tab-content="home"></div>
                <div class="tab-content" data-tab-content="services"></div>
                <div class="tab-content" data-tab-content="portfolio"></div>
                <div class="tab-content" data-tab-content="blog"></div>
            </div>
        </div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>

    <script type="module">
        import * as THREE from 'three';
        
        // Initial site data (can be loaded from localStorage later)
        const initialSiteData = {
            home: {
                title: "Crafting Digital Excellence",
                subtitle: "We create bespoke websites that elevate small businesses through elegant design and cutting-edge technology.",
                buttons: [ { text: "Start Your Project", url: "#contact" }, { text: "View Our Work", url: "#portfolio" } ]
            },
            services: [ {
                id: 'service-1', title: 'Web Development', subtitle: 'From Landing Pages to E-Commerce',
                description: 'We build fast, responsive, and secure websites tailored to your needs.',
                modalContent: 'Our development process focuses on clean code, performance, and scalability. We use modern technologies to ensure your site stands the test of time.\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.',
                media: ['https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=2070&auto=format&fit=crop', 'https://www.youtube.com/watch?v=Qdeot_p_B8s'],
                buttons: [ {text: "Get a Quote", url: "#contact"} ]
            } ],
            portfolio: [
                {
                    id: 'portfolio-1', title: 'Project Alpha', subtitle: 'Corporate Website',
                    description: 'A sleek, modern website for a leading tech consultant.',
                    modalContent: 'This project involved a complete redesign focusing on lead generation and clear communication of complex services. The result was a 40% increase in user engagement.\\n\\nVivamus vestibulum ntulla nec ante. Praesent placerat. Fusce wisi. Phasellus faucibus molestie nisl. Fusce ac felis sit amet ligula pharetra condimentum. Maecenas egestas, ante et consectetur egestas, lectus est congue tellus, non mattis eros augue et magna.',
                    media: ['https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=2070&auto=format&fit=crop'],
                    buttons: []
                },
                {
                    id: 'portfolio-matrix', title: 'Project Matrix', subtitle: 'Interactive Web Animation',
                    description: 'An immersive digital rain effect implemented with HTML5 Canvas and JavaScript.',
                    modalContent: 'This modal showcases the seamless integration of a self-contained Canvas animation as a dynamic, interactive background, creating a deeply engaging user experience.\\n\\nThe animation is encapsulated and reusable for various creative applications.',
                    media: [], specialComponent: 'matrix', buttons: []
                },
                {
                    id: 'portfolio-2', title: 'Project Beta', subtitle: 'E-Commerce Store',
                    description: 'An elegant online store for a boutique fashion brand.',
                    modalContent: 'We built a custom Shopify theme to reflect the brand\'s unique aesthetic, integrating features for a seamless shopping experience. The platform is robust, scalable, and easy for the client to manage, resulting in a significant uplift in online sales and customer satisfaction.',
                    media: ['https://images.unsplash.com/photo-1522204523234-8729aa6e3d5f?q=80&w=2070&auto=format&fit=crop', 'https://vimeo.com/394422933'],
                    buttons: [ {text: "Visit Store", url: "#"} ]
                }
            ],
            blog: [ 
                {
                    id: 'article1', title: '10 Principles of Effective Web Design', subtitle: 'June 15, 2023',
                    description: 'Discover the fundamental principles that make websites both beautiful and functional.',
                    modalContent: 'Теперь контент "парит" в воздухе над фоном. Главная страница исчезает. Каждый элемент появляется с анимацией.\\n\\nThe quick brown fox jumps over the lazy dog. The five boxing wizards jump quickly. Pack my box with five dozen liquor jugs. When zombies arrive, quickly fax judge Pat. Heavy boxes perform quick waltzes and jigs.',
                    media: ['https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=2070&auto=format&fit=crop', 'https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=2070&auto=format&fit=crop'],
                    buttons: []
                },
                {
                    id: 'blog-no-media', title: 'SEO Strategies for Small Businesses', subtitle: 'May 28, 2023',
                    description: 'Learn how to improve your online visibility without breaking the bank.',
                    modalContent: 'Это модальное окно полностью соответствует изначальному запросу и не имеет медиа-блока. Текст отображается прямо на фоне анимированных кристаллов.',
                    media: [],
                    buttons: []
                }
            ]
        };
        
        let siteData = {}; // Global variable to hold current site data
        let activeSlideshow = null; // Holds the currently active modal slideshow instance
        let slideshowIntervals = []; // Array to store intervals for card image slideshows

        // Utility function for delays
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // Promises to ensure YouTube/Vimeo APIs are ready
        const youtubeApiReady = new Promise(resolve => { window.onYouTubeIframeAPIReady = () => resolve(); });
        const vimeoApiReady = new Promise(resolve => {
            const interval = setInterval(() => { if (window.Vimeo) { clearInterval(interval); resolve(); } }, 100);
        });

        // Local Storage functions
        const saveData = () => localStorage.setItem('siteData', JSON.stringify(siteData));
        const loadData = () => {
            const storedDataString = localStorage.getItem('siteData');
            if (storedDataString) {
                try {
                    const parsedData = JSON.parse(storedDataString);
                    // Basic validation to prevent loading corrupted/incomplete data
                    if (parsedData.home && parsedData.home.buttons !== undefined) {
                        siteData = parsedData;
                        return;
                    }
                } catch (e) {
                    console.error("Failed to parse site data from localStorage", e);
                }
            }
            // If no data or data is corrupted, use initial data
            siteData = JSON.parse(JSON.stringify(initialSiteData)); // Deep copy to avoid modifying initial data directly
            saveData(); // Save it to localStorage
        };

        // --- UI Rendering Functions ---
        function rebuildUI() {
            // Preserve active admin tab after rebuild
            const activeTabKey = document.querySelector('.admin-tabs .active')?.dataset.tab || 'home';
            saveData(); // Save current state before re-rendering
            renderAllContent(); // Re-render all main content sections
            renderAdminPanel(); // Re-render admin panel
            // Re-activate the previously active admin tab
            document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`.admin-tab[data-tab="${activeTabKey}"]`)?.classList.add('active');
            document.querySelector(`.tab-content[data-tab-content="${activeTabKey}"]`)?.classList.add('active');
            initStaticEventListeners(); // Re-initialize event listeners for dynamic content
        }
        
        function renderAllContent() {
            renderHero();
            renderSection('services', 'Our Services', siteData.services);
            renderSection('portfolio', 'Our Work', siteData.portfolio);
            renderSection('blog', 'Latest Insights', siteData.blog);
            renderModals();
            initIntersectionObservers(); // Re-initialize observers for sections
        }

        function renderHero() {
            const heroSection = document.getElementById('hero');
            if (!heroSection) return;
            const { title, subtitle, buttons } = siteData.home;
            const buttonsHTML = (buttons || []).map(btn => `<a href="${btn.url}" class="cta-button">${btn.text}</a>`).join('');
            heroSection.innerHTML = `<h1 class="animated-container animated-text">${title}</h1><p class="animated-container animated-text">${subtitle}</p><div class="hero-buttons animated-container">${buttonsHTML}</div>`;
        }

        function renderSection(id, title, items) {
            const section = document.getElementById(id);
            if (!section) return;
            const itemsHTML = items.map(item => {
                if (item.specialComponent === 'matrix') {
                    // Special case for Matrix animation in a card, using an iframe for the animation
                    return `<article class="item-card animated-container" data-modal-id="${item.id}"><div class="item-card__image" style="padding: 0; overflow: hidden;"><iframe src="matrix.html" style="width:100%; height:100%; border:none; pointer-events:none; user-select:none;" title="Matrix Animation Preview"></iframe></div><div class="item-card__content"><h3 class="animated-text">${item.title}</h3><div class="card-subtitle animated-text">${item.subtitle}</div><p class="animated-text">${item.description}</p></div></article>`;
                } else {
                    // Regular card with image slideshow capability
                    const imageMedia = (item.media || []).filter(url => !/youtube|vimeo/.test(url));
                    const firstImage = imageMedia[0];
                    const imageStyle = firstImage ? `style="background-image: url('${firstImage}')"` : '';
                    return `<article class="item-card animated-container" data-modal-id="${item.id}"><div class="item-card__image" ${imageStyle} data-media-images="${imageMedia.join(',')}"></div><div class="item-card__content"><h3 class="animated-text">${item.title}</h3><div class="card-subtitle animated-text">${item.subtitle}</div><p class="animated-text">${item.description}</p></div></article>`;
                }
            }).join('');
            section.innerHTML = `<div class="animated-container"><h2 class="animated-text">${title}</h2></div><div class="item-grid">${itemsHTML}</div>`;
            initCardSlideshows(section);
        }

        function renderModals() {
            const container = document.getElementById('modal-container');
            if (!container) return;

            // Combine all items that can have modals
            const allItems = [...siteData.services, ...siteData.portfolio, ...siteData.blog];
            
            // Helper to get embed URLs for YouTube/Vimeo
            const getEmbedUrl = (url) => {
                let videoId;
                // Determine origin for security (needed for YouTube API)
                const origin = window.location.origin && window.location.origin !== 'null' ? window.location.origin : 'http://localhost';

                if (url.includes('youtube.com/watch?v=')) videoId = new URL(url).searchParams.get('v');
                else if (url.includes('youtu.be/')) videoId = new URL(url).pathname.substring(1);
                else if (url.includes('youtube.com/embed/')) videoId = url.split('/embed/')[1].split('?')[0]; // Already an embed URL
                if (videoId) return `https://www.youtube.com/embed/${videoId}?enablejsapi=1&controls=0&loop=1&playlist=${videoId}&mute=1&origin=${origin}`;

                if (url.includes('vimeo.com/')) {
                    videoId = url.split('vimeo.com/')[1].split('?')[0];
                    return `https://player.vimeo.com/video/${videoId}?loop=1&muted=1&dnt=1`;
                }
                return url; // Return original URL if not YouTube or Vimeo
            };

            container.innerHTML = allItems.map(item => {
                const paragraphsHTML = (item.modalContent || '').split('\n').filter(p => p.trim() !== '').map(p => `<p class="animated-text">${p.trim()}</p>`).join('');
                const buttonsHTML = (item.buttons || []).map(btn => `<a href="${btn.url}" class="cta-button">${btn.text}</a>`).join('');

                if (item.specialComponent === 'matrix') {
                    // Special modal type with iframe background (e.g., Matrix effect)
                    return `<div class="modal modal--has-iframe-bg" id="${item.id}">
                                <iframe class="modal-bg-iframe" src="matrix.html" title="Matrix Background Animation"></iframe>
                                <div class="modal__content">
                                    <div class="modal__text-content">
                                        <h2 class="animated-text">${item.title}</h2>
                                        ${paragraphsHTML}
                                        ${buttonsHTML ? `<div class="modal-cta-container">${buttonsHTML}</div>` : ''}
                                    </div>
                                </div>
                            </div>`;
                } else {
                    // Standard modal with media viewer (images/videos)
                    const hasMedia = item.media && item.media.length > 0;
                    const mediaHTML = hasMedia ? (item.media || []).map((url, index) => {
                        const embedUrl = getEmbedUrl(url);
                        const iframeId = `player-${item.id}-${index}`; // Unique ID for each player
                        if (embedUrl.includes('youtube') || embedUrl.includes('vimeo')) {
                            return `<div class="media-item" data-type="video"><iframe id="${iframeId}" data-src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                        }
                        return `<div class="media-item" data-type="image"><img src="${url}" alt="${item.title}"></div>`;
                    }).join('') : '';

                    return `<div class="modal" id="${item.id}">
                                <div class="modal__content">
                                    ${hasMedia ? `<div class="modal__media-viewer">${mediaHTML}</div>` : ''}
                                    <div class="modal__text-content">
                                        <h2 class="animated-text">${item.title}</h2>
                                        ${paragraphsHTML}
                                        ${buttonsHTML ? `<div class="modal-cta-container">${buttonsHTML}</div>` : ''}
                                    </div>
                                </div>
                            </div>`;
                }
            }).join('');
            initModalEventListeners(); // Re-initialize modal event listeners after DOM update
        }

        // --- Admin Panel Rendering ---
        function renderAdminPanel() {
            renderAdminHome();
            renderAdminSection('services');
            renderAdminSection('portfolio');
            renderAdminSection('blog');
        }
        
        // Helper to render buttons in admin panel (editable or disabled)
        function renderAdminButtons(buttons, isDisabled = true) {
            const disabledAttr = isDisabled ? 'disabled' : '';
            const buttonsHTML = (buttons || []).map((btn, index) => 
                `<div class="admin-button-row" data-index="${index}">
                    <input type="text" class="admin-input-button-text" placeholder="Button Text" value="${btn.text}" ${disabledAttr}>
                    <input type="text" class="admin-input-button-url" placeholder="Button URL" value="${btn.url}" ${disabledAttr}>
                    <button class="admin-btn delete-btn delete-button-btn" data-action="delete-button" ${disabledAttr}>-</button>
                </div>`
            ).join('');
            return `<div class="admin-buttons-container">
                        <label>Buttons</label>
                        <div class="buttons-list">${buttonsHTML}</div>
                        <button class="admin-btn" data-action="add-button" style="${isDisabled ? 'display:none;' : 'display:inline-block'}">+ Add Button</button>
                    </div>`;
        }
        
        function renderAdminHome() {
            const container = document.querySelector('.tab-content[data-tab-content="home"]');
            if (!container) return;
            const buttonsHTML = renderAdminButtons(siteData.home.buttons);
            container.innerHTML = `
                <div class="admin-section-header"><h2>Home Page Content</h2></div>
                <div class="admin-item" id="admin-home-item">
                    <div class="admin-item-content">
                        <label for="home-title">Title</label>
                        <input type="text" id="home-title" value="${siteData.home.title}" disabled>
                        <label for="home-subtitle">Subtitle</label>
                        <textarea id="home-subtitle" rows="4" disabled>${siteData.home.subtitle}</textarea>
                        ${buttonsHTML}
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit-home">Edit</button>
                        <button class="admin-btn save-btn" data-action="save-home">Save</button>
                    </div>
                </div>`;
        }

        function renderAdminSection(key) {
            const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`);
            if (!container) return;
            const title = key.charAt(0).toUpperCase() + key.slice(1); // e.g., "Services"
            const itemsHTML = siteData[key].map(item => `
                <div class="admin-item" data-id="${item.id}" data-key="${key}">
                    <div class="admin-item-content">
                        <label>Title</label><input type="text" class="admin-input-title" value="${item.title}" disabled>
                        <label>Subtitle / Date</label><input type="text" class="admin-input-subtitle" value="${item.subtitle}" disabled>
                        <label>Card Description</label><textarea class="admin-input-description" rows="3" disabled>${item.description}</textarea>
                        <label>Modal Content (use new lines for paragraphs)</label><textarea class="admin-input-modalContent" rows="5" disabled>${item.modalContent}</textarea>
                        <label>Modal Media (Image/YouTube/Vimeo URLs, one per line)</label><textarea class="admin-input-media" rows="4" disabled ${item.specialComponent ? 'placeholder="Special component is active"': ''}>${(item.media || []).join('\n')}</textarea>
                        ${renderAdminButtons(item.buttons)}
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit">Edit</button>
                        <button class="admin-btn save-btn" data-action="save">Save</button>
                        <button class="admin-btn delete-btn" data-action="delete">Delete</button>
                    </div>
                </div>`).join('');
            container.innerHTML = `
                <div class="admin-section-header">
                    <h2>Manage ${title}</h2>
                    <button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button>
                </div>
                ${itemsHTML}`;
        }

        // --- Modal Control Functions ---
        const modalCloseBtn = document.querySelector('.modal__close');
        
        const openModal = (modal) => {
            if (!modal) return;
            document.body.classList.add('modal-is-open');
            modal.classList.add('is-active');
            modalCloseBtn.classList.add('is-active'); // Show close button
            triggerModalAnimations(modal); // Animate text inside modal
            if (!modal.classList.contains('modal--has-iframe-bg')) {
                initializeModalSlideshow(modal); // Initialize slideshow for regular modals
            }
        };

        const closeModal = () => {
            const activeModal = document.querySelector('.modal.is-active');
            if (!activeModal) return;
            document.body.classList.remove('modal-is-open');
            activeModal.classList.remove('is-active');
            modalCloseBtn.classList.remove('is-active'); // Hide close button
            // Clear any active slideshow/video playback
            if (activeSlideshow && activeSlideshow.clear) {
                activeSlideshow.clear();
                activeSlideshow = null;
            }
            // Reset scroll position of modal content
            const content = activeModal.querySelector('.modal__content');
            if (content) content.scrollTop = 0;
        };

        // --- Event Listener Initialization ---
        function initStaticEventListeners() {
            // Remove previous listeners to prevent duplicates
            document.querySelector('.menu-toggle')?.removeEventListener('click', toggleNavMenu);
            document.querySelectorAll('.nav-menu a:not(#admin-toggle)').forEach(link => {
                link.removeEventListener('click', closeNavMenu);
            });
            document.getElementById('admin-toggle')?.removeEventListener('click', openAdminPanel);
            document.getElementById('admin-close-btn')?.removeEventListener('click', closeAdminPanel);
            document.querySelector('.admin-tabs')?.removeEventListener('click', handleAdminTabClick);
            document.querySelector('.admin-content')?.removeEventListener('click', handleAdminActions);
            document.querySelector('main')?.removeEventListener('click', handleMainCardClick);
            modalCloseBtn.removeEventListener('click', closeModal);
            document.getElementById('modal-container')?.removeEventListener('click', handleModalOverlayClick);
            window.removeEventListener('keydown', handleEscapeKey);

            // Add new listeners
            document.querySelector('.menu-toggle')?.addEventListener('click', toggleNavMenu);
            document.querySelectorAll('.nav-menu a:not(#admin-toggle)').forEach(link => {
                link.addEventListener('click', closeNavMenu);
            });
            document.getElementById('admin-toggle')?.addEventListener('click', openAdminPanel);
            document.getElementById('admin-close-btn')?.addEventListener('click', closeAdminPanel);
            document.querySelector('.admin-tabs')?.addEventListener('click', handleAdminTabClick);
            document.querySelector('.admin-content')?.addEventListener('click', handleAdminActions);
            document.querySelector('main')?.addEventListener('click', handleMainCardClick);
            initModalEventListeners(); // This one already adds/removes internally correctly
        }
        
        function toggleNavMenu() {
            this.classList.toggle('is-active');
            document.querySelector('.nav-overlay')?.classList.toggle('is-active');
            document.body.classList.toggle('nav-is-open');
        }

        function closeNavMenu() {
            document.querySelector('.menu-toggle')?.classList.remove('is-active');
            document.querySelector('.nav-overlay')?.classList.remove('is-active');
            document.body.classList.remove('nav-is-open');
        }

        function openAdminPanel(e) {
            e.preventDefault(); 
            document.getElementById('admin-panel').classList.add('active');
        }

        function closeAdminPanel() {
            document.getElementById('admin-panel').classList.remove('active');
        }

        function handleAdminTabClick(e) {
            if (e.target.matches('.admin-tab')) {
                document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelector(`.tab-content[data-tab-content="${e.target.dataset.tab}"]`)?.classList.add('active');
            }
        }

        function handleMainCardClick(e) {
            const card = e.target.closest('.item-card');
            if (card) {
                const modal = document.getElementById(card.dataset.modalId);
                openModal(modal);
            }
        }
        
        function initModalEventListeners() {
            // Remove previous listeners before adding to prevent duplicates
            modalCloseBtn.removeEventListener('click', closeModal);
            document.getElementById('modal-container').removeEventListener('click', handleModalOverlayClick);
            window.removeEventListener('keydown', handleEscapeKey);

            // Add new listeners
            modalCloseBtn.addEventListener('click', closeModal);
            document.getElementById('modal-container').addEventListener('click', handleModalOverlayClick);
            window.addEventListener('keydown', handleEscapeKey);
        }

        function handleModalOverlayClick(e) {
            if (e.target.matches('.modal')) { // Only close if clicked directly on the modal background
                closeModal();
            }
        }

        function handleEscapeKey(e) {
            if (e.key === "Escape") {
                closeModal();
            }
        }
        
        function handleAdminActions(e) {
            const target = e.target;
            const action = target.dataset.action;
            if (!action) return;

            const itemEl = target.closest('.admin-item');
            
            // Helper to toggle edit mode for an admin item
            const toggleEditing = (element, isEditing) => {
                element.classList.toggle('is-editing', !isEditing); // isEditing means we are switching to display mode
                element.querySelectorAll('input, textarea, .delete-button-btn').forEach(input => input.disabled = isEditing);
                // Control visibility of the "Add Button" button
                element.querySelector('[data-action="add-button"]')?.style.setProperty('display', isEditing ? 'none' : 'inline-block');
            };

            // Handle actions for the Home section separately as it's a single item
            if (action === 'edit-home' || action === 'save-home') {
                const isEditing = itemEl.classList.contains('is-editing');
                toggleEditing(itemEl, isEditing); // Toggle edit state
                if (action === 'save-home') {
                    // Save changes to siteData.home
                    siteData.home.title = itemEl.querySelector('#home-title').value;
                    siteData.home.subtitle = itemEl.querySelector('#home-subtitle').value;
                    // Update buttons array
                    siteData.home.buttons = Array.from(itemEl.querySelectorAll('.admin-button-row')).map(row => ({ 
                        text: row.querySelector('.admin-input-button-text').value, 
                        url: row.querySelector('.admin-input-button-url').value 
                    }));
                    saveData(); // Save to local storage
                    renderHero(); // Re-render hero section to reflect changes
                    initIntersectionObservers(); // Re-initialize observers as content might have changed
                }
                return;
            }

            // For other sections (services, portfolio, blog)
            const key = target.dataset.key || itemEl?.dataset.key; // e.g., 'services'
            const id = itemEl ? itemEl.dataset.id : null; // Unique ID of the item
            
            switch(action) {
                case 'edit':
                    toggleEditing(itemEl, false); // Enter edit mode
                    break;
                case 'save': {
                    const itemData = siteData[key].find(item => item.id === id);
                    if (itemData) {
                        // Update item properties from input fields
                        itemData.title = itemEl.querySelector('.admin-input-title').value;
                        itemData.subtitle = itemEl.querySelector('.admin-input-subtitle').value;
                        itemData.description = itemEl.querySelector('.admin-input-description').value;
                        itemData.modalContent = itemEl.querySelector('.admin-input-modalContent').value;
                        // Only update media if it's not a special component (like matrix)
                        if (!itemData.specialComponent) { 
                            itemData.media = itemEl.querySelector('.admin-input-media').value.split('\n').map(s => s.trim()).filter(Boolean); 
                        }
                        // Update buttons for the item
                        itemData.buttons = Array.from(itemEl.querySelectorAll('.admin-button-row')).map(row => ({ 
                            text: row.querySelector('.admin-input-button-text').value, 
                            url: row.querySelector('.admin-input-button-url').value 
                        }));
                    }
                    toggleEditing(itemEl, true); // Exit edit mode
                    rebuildUI(); // Re-render the entire UI to reflect changes
                    break;
                }
                case 'delete':
                    if (confirm('Are you sure you want to delete this item?')) {
                        siteData[key] = siteData[key].filter(item => item.id !== id);
                        rebuildUI(); // Re-render after deletion
                    }
                    break;
                case 'add':
                    // Add a new item with default values
                    siteData[key].push({ 
                        id: `${key}-${Date.now()}`, 
                        title: 'New Item', 
                        subtitle: 'New Subtitle', 
                        description: 'New description.', 
                        modalContent: 'New modal content.', 
                        media: [], 
                        buttons: [] 
                    }); 
                    rebuildUI(); // Re-render to show the new item
                    break;
                case 'add-button': {
                    // Add a new button input row to the current item
                    const list = target.previousElementSibling; // The .buttons-list div
                    const newRow = document.createElement('div');
                    newRow.className = 'admin-button-row';
                    newRow.innerHTML = `<input type="text" class="admin-input-button-text" placeholder="Button Text" value=""><input type="text" class="admin-input-button-url" placeholder="Button URL" value="#"><button class="admin-btn delete-btn delete-button-btn" data-action="delete-button">-</button>`;
                    list.appendChild(newRow);
                    break;
                }
                case 'delete-button':
                    // Remove a button input row
                    target.closest('.admin-button-row').remove();
                    break;
            }
        }

        // --- Card Slideshow (for item cards in sections) ---
        function initCardSlideshows(section) {
            // Clear existing intervals to prevent memory leaks and multiple slideshows
            slideshowIntervals.forEach(clearInterval);
            slideshowIntervals = [];

            section.querySelectorAll('.item-card__image').forEach(imageEl => {
                if (!imageEl.dataset.mediaImages) return; 
                const media = imageEl.dataset.mediaImages.split(',').filter(Boolean); // Get image URLs
                
                if (media.length > 1) {
                    let currentIndex = 0;
                    const intervalId = setInterval(() => {
                        imageEl.style.opacity = 0; // Fade out current image
                        setTimeout(() => {
                            currentIndex = (currentIndex + 1) % media.length; // Next image
                            imageEl.style.backgroundImage = `url('${media[currentIndex]}')`;
                            imageEl.style.opacity = 1; // Fade in new image
                        }, 500); // Wait for fade out to complete before changing image
                    }, 5000); // Change image every 5 seconds
                    slideshowIntervals.push(intervalId);
                }
            });
        }
        
        // --- Modal Media Slideshow (for media viewer inside modals) ---
        async function initializeModalSlideshow(modal) {
            // Clear any previously active slideshow
            if (activeSlideshow?.clear) activeSlideshow.clear();

            const mediaViewer = modal.querySelector('.modal__media-viewer');
            const mediaItems = Array.from(modal.querySelectorAll('.media-item'));
            if (!mediaViewer || mediaItems.length === 0) return; // No media to show

            // Ensure YouTube and Vimeo APIs are loaded before proceeding
            await Promise.all([youtubeApiReady, vimeoApiReady]);

            const state = { 
                currentIndex: -1, // Current active slide index
                players: {},      // Stores YouTube/Vimeo player instances
                savedTimestamps: {}, // Stores current playback time for videos
                isTransitioning: false, // Flag to prevent rapid transitions
                isCleared: false,   // Flag to indicate if slideshow has been cleared
                timerId: null,      // Timeout ID for auto-advance
                touchStartX: 0,     // For swipe functionality
            };

            const transitionToSlide = async (newIndex) => {
                if (state.isTransitioning || state.isCleared) return;
                state.isTransitioning = true; 
                clearTimeout(state.timerId); // Stop current auto-advance timer

                await pauseAndSaveCurrentPlayer(); // Pause current video and save time

                if (mediaItems[state.currentIndex]) {
                    mediaItems[state.currentIndex].classList.remove('is-active');
                }
                
                await sleep(500); // Wait for fade-out animation

                if(state.isCleared) { // Check if cleared during the sleep
                    state.isTransitioning = false; 
                    return; 
                }

                destroyPlayer(state.currentIndex); // Destroy player instance if it exists

                state.currentIndex = newIndex;
                const newItem = mediaItems[state.currentIndex];
                newItem.classList.add('is-active'); // Show new slide

                if (newItem.dataset.type === 'video') {
                    await createAndPlayNewPlayer(state.currentIndex); // Create and play video
                }

                // If not cleared and more than one item, set up next auto-advance
                if (!state.isCleared && mediaItems.length > 1) {
                    const duration = newItem.dataset.type === 'video' 
                        ? ((await state.players[state.currentIndex]?.getDuration?.()) * 1000 || 5000) // Use video duration or 5s
                        : 5000; // 5 seconds for images
                    state.timerId = setTimeout(() => transitionToSlide((state.currentIndex + 1) % mediaItems.length), duration);
                }
                state.isTransitioning = false;
            };

            // Helper to pause current video and save its timestamp
            const pauseAndSaveCurrentPlayer = async () => { 
                try { 
                    const player = state.players[state.currentIndex]; 
                    if (!player) return; 

                    if (player.getPlayerState) { // YouTube player
                        if ([1, 3].includes(player.getPlayerState())) { // Playing or Buffering
                            state.savedTimestamps[state.currentIndex] = await player.getCurrentTime();
                            player.pauseVideo();
                        }
                    } else if (player.getPaused) { // Vimeo player
                        const isPaused = await player.getPaused();
                        if (!isPaused) {
                            state.savedTimestamps[state.currentIndex] = await player.getCurrentTime();
                            await player.pause();
                        }
                    } 
                } catch(e) { 
                    console.error("Error pausing video", e); 
                } 
            };

            // Helper to destroy player instances to free up resources
            const destroyPlayer = (index) => { 
                const player = state.players[index]; 
                if (player?.destroy) player.destroy(); 
                delete state.players[index]; 
            };

            // Helper to create and play new video player
            const createAndPlayNewPlayer = (index) => new Promise(resolve => {
                const item = mediaItems[index]; 
                const iframe = item.querySelector('iframe'); 
                if (!iframe) return resolve(); // Not an iframe, resolve immediately

                // Set iframe src from data-src attribute (lazy load)
                if (iframe.dataset.src && !iframe.src) iframe.src = iframe.dataset.src;

                if (iframe.src.includes('youtube')) { 
                    state.players[index] = new YT.Player(iframe.id, { 
                        events: { 
                            'onReady': e => { 
                                if (state.isCleared) return; // Prevent playing if already cleared
                                e.target.seekTo(state.savedTimestamps[index] || 0, true); // Seek to saved time or start
                                e.target.playVideo(); // Start playback
                                resolve(); 
                            }, 
                            'onStateChange': e => { 
                                if (e.data === 0) e.target.seekTo(0); // Loop video
                            }, 
                        } 
                    }); 
                } 
                else if (iframe.src.includes('vimeo')) { 
                    const player = new Vimeo.Player(iframe); 
                    state.players[index] = player; 
                    player.ready().then(() => { 
                        if(state.isCleared) return; // Prevent playing if already cleared
                        player.setCurrentTime(state.savedTimestamps[index] || 0).finally(resolve); // Seek to saved time or start
                        player.play(); // Start playback
                        player.on('ended', () => player.setCurrentTime(0)); // Loop video
                    }); 
                } 
                else { 
                    resolve(); // Not a video iframe
                }
            });

            // Public method to clear the slideshow state and resources
            const clear = () => { 
                state.isCleared = true; 
                clearTimeout(state.timerId); 
                mediaViewer.removeEventListener('touchstart', handleTouchStart); 
                mediaViewer.removeEventListener('touchend', handleTouchEnd); 
                Object.keys(state.players).forEach(destroyPlayer); 
            };
            activeSlideshow = { clear }; // Assign clear method to global activeSlideshow

            // Touch event handlers for swiping
            const handleTouchStart = e => { state.touchStartX = e.touches[0].clientX; };
            const handleTouchEnd = e => { 
                const deltaX = e.changedTouches[0].clientX - state.touchStartX; 
                if (Math.abs(deltaX) > 50) { // Swipe threshold
                    transitionToSlide(deltaX < 0 
                        ? (state.currentIndex + 1) % mediaItems.length // Swipe left for next
                        : (state.currentIndex - 1 + mediaItems.length) % mediaItems.length); // Swipe right for previous
                } 
            };

            // Add touch listeners if there's more than one media item
            if (mediaItems.length > 1) { 
                mediaViewer.addEventListener('touchstart', handleTouchStart, { passive: true }); 
                mediaViewer.addEventListener('touchend', handleTouchEnd, { passive: true }); 
            }
            
            // Start the slideshow by transitioning to the first slide
            transitionToSlide(0);
        }

        // --- Text Animation Functions ---
        function animateTextLetters(element) {
            if (!element) return; 
            // Reset element to re-animate
            element.dataset.animated = false; 
            element.classList.remove('is-animating'); 
            element.innerHTML = element.textContent; // Reset content to raw text

            // Prepare for re-animation
            element.dataset.animated = true; 
            element.classList.add('is-animating');
            const text = element.textContent.trim(); 
            element.innerHTML = ''; // Clear content for letter-by-letter insertion

            const words = text.split(/\s+/);
            words.forEach((word, wordIndex) => {
                const wordWrapper = document.createElement('span'); 
                wordWrapper.style.display = 'inline-block'; // Keep words together

                word.split('').forEach((char) => { 
                    const span = document.createElement('span'); 
                    span.textContent = char; 
                    span.style.animationDelay = `${Math.random() * 0.5}s`; // Random delay for "falling" effect
                    wordWrapper.appendChild(span); 
                });
                element.appendChild(wordWrapper); 
                if (wordIndex < words.length - 1) { 
                    element.appendChild(document.createTextNode(' ')); // Add space between words
                }
            });
        }

        function activateContainer(container) {
            if (container.classList.contains('active')) return; // Already active
            container.classList.add('active');
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const elementsToAnimate = container.classList.contains('animated-text') ? [container] : container.querySelectorAll('.animated-text');
            
            if (prefersReducedMotion) { 
                elementsToAnimate.forEach(el => animateTextLetters(el)); 
                return; 
            }
            // Add a slight delay to allow CSS transitions to start before text animation
            setTimeout(() => { elementsToAnimate.forEach(animateTextLetters); }, 300);
        }

        function triggerModalAnimations(modal) {
            // Animate text elements inside the modal when it opens
            const textElements = modal.querySelectorAll('.animated-text');
            setTimeout(() => { textElements.forEach(el => animateTextLetters(el)); }, 500); 
        }
        
        // --- Intersection Observer for Scroll Animations ---
        let observer; // Global observer instance
        function initIntersectionObservers() {
             if (observer) observer.disconnect(); // Disconnect existing observer if any

             observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = entry.target;
                        const containers = section.querySelectorAll('.animated-container');
                        containers.forEach((container, index) => { 
                            // Stagger animation for containers within a section
                            setTimeout(() => { activateContainer(container); }, index * 150); 
                        });
                        obs.unobserve(section); // Stop observing once animated
                    }
                });
            }, { threshold: 0.4 }); // Trigger when 40% of the section is visible

            // Observe all sections in the main content
            document.querySelectorAll("main > section").forEach(section => { observer.observe(section); });
        }

        // --- Three.js Background Animation ---
        let crystalMaterial; // Material for the crystals
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5; // Initial camera position
        const canvas = document.getElementById("webgl-canvas");
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Use higher pixel ratio for sharper rendering
        
        scene.add(new THREE.AmbientLight(0x404040, 2)); // Soft ambient light
        const pointLight1 = new THREE.PointLight(0x00aaff, 30, 20); // Blue point light
        pointLight1.position.set(5, 5, 5);
        scene.add(pointLight1);

        const crystalGroup = new THREE.Group(); // Group to hold all crystals
        scene.add(crystalGroup);

        // Custom ShaderMaterial for crystal appearance
        crystalMaterial = new THREE.ShaderMaterial({
            uniforms: { 
                time: { value: 0 }, 
                color1: { value: new THREE.Color(0xb8d8e8) }, // Light blue
                color2: { value: new THREE.Color(0x1d2a3a) }, // Dark blue-grey
            },
            // Vertex shader: calculates normals and position for fragment shader
            vertexShader: `
                varying vec3 vNormal; 
                varying vec3 vPosition; 
                void main() { 
                    vNormal = normalize(normalMatrix * normal); 
                    vPosition = position; 
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); 
                }
            `,
            // Fragment shader: calculates final color with noise and Fresnel effect
            fragmentShader: `
                uniform float time; 
                uniform vec3 color1; 
                uniform vec3 color2; 
                varying vec3 vNormal; 

                // Simplex noise function (common for procedural textures/animations)
                float snoise(vec3 v){ 
                    const vec2 C = vec2(1.0/6.0, 1.0/3.0) ; 
                    const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); 
                    vec3 i = floor(v + dot(v, C.yyy) ); 
                    vec3 x0 = v - i + dot(i, C.xxx) ; 
                    vec3 g = step(x0.yzx, x0.xyz); 
                    vec3 l = 1.0 - g; 
                    vec3 i1 = min( g.xyz, l.zxy ); 
                    vec3 i2 = max( g.xyz, l.zxy ); 
                    vec3 x1 = x0 - i1 + C.xxx; 
                    vec3 x2 = x0 - i2 + C.yyy; 
                    vec3 x3 = x0 - D.yyy; 
                    i = mod(i, 289.0); 
                    vec4 p = mod(((i.z + vec4(0.0, i1.z, i2.z, 1.0 ))*34.0+1.0)* (i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 ), 289.0); 
                    p = mod(((p)*34.0+1.0)*(p) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ), 289.0); 
                    vec4 j = p - 49.0 * floor(p * (1.0/7.0) * (1.0/7.0)); 
                    vec4 x_ = floor(j * (1.0/7.0)); 
                    vec4 y_ = floor(j - 7.0 * x_ ); 
                    vec4 x = x_ * (2.0/7.0) - 1.0 + (1.0/7.0); 
                    vec4 y = y_ * (2.0/7.0) - 1.0 + (1.0/7.0); 
                    vec4 h = 1.0 - abs(x) - abs(y); 
                    vec4 b0 = vec4( x.xy, y.xy ); 
                    vec4 b1 = vec4( x.zw, y.zw ); 
                    vec4 s0 = floor(b0)*2.0 + 1.0; 
                    vec4 s1 = floor(b1)*2.0 + 1.0; 
                    vec4 sh = -step(h, vec4(0.0)); 
                    vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ; 
                    vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ; 
                    vec3 p0 = vec3(a0.xy,h.x); 
                    vec3 p1 = vec3(a0.zw,h.y); 
                    vec3 p2 = vec3(a1.xy,h.z); 
                    vec3 p3 = vec3(a1.zw,h.w); 
                    vec4 norm = inversesqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3))); 
                    p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; 
                    vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0); 
                    m = m * m; 
                    return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) ); 
                } 

                void main() { 
                    float noise = snoise(vNormal * 3.0 + time * 0.1); // Add animated noise
                    vec3 baseColor = mix(color1, color2, vNormal.y * 0.5 + 0.5); // Mix colors based on normal Y
                    float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 3.0); // Fresnel effect
                    vec3 finalColor = baseColor + fresnel * vec3(0.8, 0.9, 1.0) * 0.5; // Add Fresnel glow
                    finalColor += noise * 0.2; // Blend in noise
                    gl_FragColor = vec4(finalColor, fresnel * 0.8 + 0.2); // Apply transparency based on Fresnel
                }
            `,
            transparent: true, 
            blending: THREE.AdditiveBlending, // Additive blending for glow effect
            depthWrite: false, // Don't write to depth buffer for transparent objects
        });

        const coreCrystal = new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 1), crystalMaterial);
        crystalGroup.add(coreCrystal);

        let branches = []; // Array to store smaller crystal branches
        let crystalGrowth = 0; // Controls overall crystal scale/branching
        
        // Function to add a new crystal branch
        const addBranch = () => {
            if (branches.length > 50) return; // Limit number of branches
            const branch = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1 + Math.random() * 0.4, 0), crystalMaterial);
            // Random spherical position
            const phi = Math.random() * Math.PI * 2;
            const theta = Math.acos(Math.random() * 2 - 1);
            const radius = 1 + Math.random() * crystalGrowth; // Radius based on overall growth
            branch.position.set( 
                radius * Math.sin(theta) * Math.cos(phi), 
                radius * Math.sin(theta) * Math.sin(phi), 
                radius * Math.cos(theta) 
            );
            branch.rotation.set(Math.random(), Math.random(), Math.random()); // Random initial rotation
            branch.scale.set(0.01, 0.01, 0.01); // Start very small
            crystalGroup.add(branch);
            branches.push({ mesh: branch, life: 0, maxLife: 0.5 + Math.random() * 1.5 }); // Track life for scaling animation
        };

        const clock = new THREE.Clock();
        let scrollFraction = 0; // Normalized scroll position (0 to 1)
        let introComplete = false;
        const introDuration = 5; // Duration of intro animation in seconds

        // Main animation loop
        function animate() {
            requestAnimationFrame(animate);

            const elapsedTime = clock.getElapsedTime();
            if (crystalMaterial) crystalMaterial.uniforms.time.value = elapsedTime; // Update shader time uniform

            // Calculate intro progress and crystal growth based on time and scroll
            let introProgress = introComplete ? 1.0 : Math.min(elapsedTime / introDuration, 1.0);
            if (introProgress >= 1.0) introComplete = true;

            // Crystal growth depends on intro progress and scroll
            crystalGrowth = Math.max(introProgress * 1.5, Math.min(scrollFraction * 5, 2.5));

            // Randomly add new branches if crystal is growing
            if (crystalGrowth > 0.1 && Math.random() > 0.9) addBranch();

            // Camera movement based on intro and scroll
            camera.position.z = 5 - Math.max(introProgress * 1.0, scrollFraction * 2);
            camera.position.y = scrollFraction * 1;
            camera.lookAt(scene.position);

            // Rotate the main crystal group
            crystalGroup.rotation.y += 0.001;
            crystalGroup.rotation.x += 0.0005;

            // Scale the core crystal based on crystalGrowth
            coreCrystal.scale.setScalar(1 + crystalGrowth * 0.5);

            // Animate branch growth
            branches.forEach(b => { 
                if (b.life < b.maxLife) { 
                    b.life += 0.01; 
                    // Scale branch up using a sine wave for smooth growth
                    b.mesh.scale.setScalar(Math.sin(b.life / b.maxLife * Math.PI * 0.5)); 
                } 
            });

            renderer.render(scene, camera); // Render the scene
        }

        // --- Window Event Listeners ---
        window.addEventListener('load', () => {
            // Hide preloader after page load
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            loadData(); // Load site data from localStorage
            rebuildUI(); // Build the UI based on loaded data
            animate(); // Start the Three.js animation loop
        });

        window.addEventListener("scroll", () => {
            const scrollableHeight = document.body.scrollHeight - window.innerHeight;
            scrollFraction = scrollableHeight > 0 ? window.scrollY / scrollableHeight : 0;
        });

        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>