<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft | Portfolio</title>
    <meta name="description" content="Professional websites for small businesses">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* --- Global Variables --- */
        :root {
            --color-bg: #030409;
            --color-text: #eaf6ff;
            --color-accent: #b8d8e8;
            --color-card: rgba(25, 29, 45, 0.4);
            --color-border: rgba(184, 216, 232, 0.2);
            --font-main: 'Cormorant Garamond', serif;
            --header-height: 80px;
        }

        /* --- Base Styles --- */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        a {
            color: var(--color-accent);
            text-decoration: none;
        }

        /* --- Preloader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-bg); display: flex; justify-content: center;
            align-items: center; z-index: 10000; transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--color-accent);
            border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Crystal Canvas --- */
        #webgl-canvas {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh; z-index: 0;
        }

        /* --- Main content --- */
        main {
            position: relative; z-index: 2; max-width: 1200px;
            margin: 0 auto; padding: 100px 30px;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        body.modal-is-open main, body.nav-is-open main {
            opacity: 0; transform: translateY(20px); pointer-events: none;
        }

        /* --- Animation System --- */
        section {
            margin-bottom: 120px;
            perspective: 1000px;
        }

        .animated-container {
            opacity: 0;
            transform: translateX(-30px) rotate(-5deg);
            transition: all 0.7s cubic-bezier(0.2, 0.9, 0.3, 1.1);
        }

        .animated-container.active {
            opacity: 1;
            transform: none;
        }
        
        @keyframes letterAppear {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: none; }
        }

        .animated-text {
            color: transparent; 
        }

        .animated-text.is-animating {
            color: initial;
        }

        .animated-text span {
            display: inline-block;
            opacity: 0;
            animation: letterAppear 0.5s forwards;
        }

        /* --- Generic Cards --- */
        .item-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-top: 40px;
        }
        .item-card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 8px; overflow: hidden; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .item-card:hover {
            transform: translateY(-10px) scale(1.02) !important;
            border-color: var(--color-accent); box-shadow: 0 10px 30px rgba(184, 216, 232, 0.3);
        }
        .item-card__image {
            height: 200px;
            background: linear-gradient(135deg, rgba(184, 216, 232, 0.1), rgba(25, 29, 45, 0.7));
            background-size: cover; background-position: center;
            opacity: 1; transition: opacity 0.5s ease-in-out;
        }
        .item-card__content { padding: 25px; }
        .item-card h3 { margin: 0 0 10px; font-size: 1.5rem; transition: color 0.3s ease-out; }
        .item-card:hover h3 { color: var(--color-accent); }
        .item-card .card-subtitle { display: block; margin-bottom: 15px; opacity: 0.8; font-size: 0.9rem; }
        .item-card p { margin: 0; opacity: 0.9; }

        /* --- Modern Menu --- */
        .menu-toggle {
            position: fixed; top: 30px; right: 30px; z-index: 1000;
            background: transparent; border: none; padding: 0; cursor: pointer;
            width: 30px; height: 24px; display: flex; flex-direction: column;
            justify-content: space-between; transition: transform 0.4s;
        }
        .menu-toggle:hover { transform: scale(1.1); }
        .menu-toggle .bar { background: #FFFFFF; height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        .nav-overlay {
            position: fixed; top: 0; right: -100%; width: 400px; height: 100vh;
            background: transparent; z-index: 999;
            transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); overflow: hidden;
        }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; }
        .nav-menu li { margin-bottom: 25px; opacity: 0; transform: translateX(30px); transition: all 0.4s ease-out; }
        .nav-overlay.is-active .nav-menu li { opacity: 1; transform: translateX(0); }
        .nav-menu li:nth-child(1) { transition-delay: 0.1s; } .nav-menu li:nth-child(2) { transition-delay: 0.2s; }
        .nav-menu li:nth-child(3) { transition-delay: 0.3s; } .nav-menu li:nth-child(4) { transition-delay: 0.4s; }
        .nav-menu li:nth-child(5) { transition-delay: 0.5s; } .nav-menu li:nth-child(6) { transition-delay: 0.6s; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; position: relative; padding-bottom: 5px; transition: all 0.3s ease-out; }
        .nav-menu a:hover { color: var(--color-accent); transform: translateX(5px); }
        .nav-menu a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: var(--color-accent); transition: width 0.4s; }
        .nav-menu a:hover::after { width: 100%; }

        /* --- Hero Section --- */
        .hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; }
        .hero h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0 0 20px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .hero p { font-size: 1.4rem; max-width: 600px; margin-bottom: 40px; }
        .cta-button {
            display: inline-block; padding: 14px 32px; text-decoration: none; font-weight: 600;
            font-size: 1rem; color: var(--color-text); border: 1px solid var(--color-accent);
            background-color: rgba(44, 75, 90, 0.3); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .cta-button:hover { transform: translateY(-5px) scale(1.05); border-color: var(--color-text); box-shadow: 0 5px 25px 5px rgba(184, 216, 232, 0.4); }

        /* --- Modal Windows --- */
        #modal-container { position: relative; z-index: 1001; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .modal.is-active { opacity: 1; pointer-events: all; }
        .modal__content { 
            max-width: 800px; width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: left; padding: 0;
            position: relative; 
            border-radius: 8px;
            scrollbar-width: none;
        }
        .modal__content::-webkit-scrollbar {
            display: none;
        }
        .modal__text-content {
             padding: 40px;
             max-width: 650px;
             margin: 0 auto;
        }
        .modal__content h2, .modal__content p, .modal__close {
            opacity: 0; transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; text-shadow: 0 2px 15px rgba(0, 0, 0, 0.8);
        }
        .modal.is-active .modal__content h2, .modal.is-active .modal__content p, .modal.is-active .modal__close, .modal.is-active .modal__media-viewer {
            opacity: 1; transform: translateY(0);
        }
        .modal.is-active .modal__close { transition-delay: 0.2s; }
        .modal.is-active .modal__media-viewer { transition-delay: 0.3s; }
        .modal.is-active .modal__content h2 { transition-delay: 0.4s; }
        .modal.is-active .modal__content p { transition-delay: 0.5s; }
        .modal__content h2 { font-size: 2.5rem; margin-bottom: 20px; color: var(--color-text); text-align: center; } /* MANDATE 2: Color changed to --color-text */
        .modal__content p { font-size: 1.2rem; line-height: 1.6; text-align: left; }
        .modal__close {
            position: absolute; bottom: 30px; left: 30px; background: none; border: none; cursor: pointer;
            width: 30px; height: 24px; display: flex; flex-direction: column; justify-content: space-between; padding: 0; z-index: 10;
        }
        .modal__close .bar { background: var(--color-text); height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: left; }
        .modal__close .bar:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        .modal__close .bar:nth-child(2) { opacity: 0; }
        .modal__close .bar:nth-child(3) { transform: translateY(-11px) rotate(-45deg); }
        .modal__close:hover .bar { background: var(--color-accent); }
        .modal__media-viewer {
            position: sticky; top: 0; z-index: 5;
            width: 100%; aspect-ratio: 16 / 9;
            background: rgba(3, 4, 9, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            touch-action: pan-y;
        }
        .modal__media-viewer .media-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease-in-out;
            display: flex; justify-content: center; align-items: center;
        }
        .modal__media-viewer .media-item.is-active { opacity: 1; visibility: visible; }
        .modal__media-viewer img { width: 100%; height: 100%; object-fit: cover; }
        .modal__media-viewer iframe { width: 100%; height: 100%; border: none; }

        /* --- Admin Panel --- */
        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 4, 9, 0.95);
            z-index: 10000; display: none; overflow-y: auto; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        #admin-panel.active { display: block; }
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: rgba(25, 29, 45, 0.8); padding: 30px; border-right: 1px solid var(--color-border); position: sticky; top: 0; height: 100vh; }
        .admin-sidebar h3 { margin-top: 0; }
        .admin-sidebar ul { list-style: none; padding: 0; }
        .admin-sidebar ul li { margin-bottom: 10px; }
        .admin-content { flex: 1; padding: 40px; }
        .admin-tabs { list-style: none; padding: 0; }
        .admin-tab { padding: 10px 0; cursor: pointer; transition: all 0.3s; }
        .admin-tab.active { color: var(--color-accent); font-weight: bold; }
        .admin-tab:not(.active):hover { color: var(--color-accent); transform: translateX(5px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #admin-close-btn { position: absolute; top: 25px; right: 25px; background: none; border: none; color: var(--color-text); font-size: 2rem; cursor: pointer; transition: all 0.3s; line-height: 1; }
        #admin-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .admin-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; margin-bottom: 30px; }
        .admin-item { background: var(--color-card); padding: 20px; border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 20px; }
        .admin-item-content { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .admin-item label { font-size: 0.9rem; opacity: 0.8; margin-bottom: -10px; }
        .admin-item input, .admin-item textarea {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--color-border); color: var(--color-text);
            padding: 10px; border-radius: 4px; font-family: inherit; font-size: 1rem; transition: all 0.3s; box-sizing: border-box;
        }
        .admin-item input:disabled, .admin-item textarea:disabled { background: transparent; border-color: transparent; color: var(--color-text); }
        .admin-item input:focus, .admin-item textarea:focus { border-color: var(--color-accent); background: rgba(0,0,0,0.4); }
        .admin-item textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        .admin-item-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .admin-btn { padding: 8px 16px; border: 1px solid var(--color-accent); background: rgba(184, 216, 232, 0.1); color: var(--color-accent); border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(184, 216, 232, 0.3); color: var(--color-text); }
        .admin-btn.delete-btn { border-color: #e57373; color: #e57373; }
        .admin-btn.delete-btn:hover { background: rgba(229, 115, 115, 0.3); color: var(--color-text); }
        .admin-btn.save-btn { display: none; }
        .admin-item.is-editing .edit-btn { display: none; }
        .admin-item.is-editing .save-btn { display: inline-block; }

        /* --- Reduced Motion & Responsive --- */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .animated-container { opacity: 1; transform: none; transition: none; }
            .animated-text span { opacity: 1; transform: none; animation: none; }
        }
        
        @media (max-width: 768px) {
            .animated-container { transform: translateX(-15px) rotate(-2deg); }
            .nav-overlay { width: 100%; }
            .hero h1 { font-size: 2.5rem; }
            .item-grid { grid-template-columns: 1fr; }
            .admin-container { flex-direction: column; }
            .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-border); position: static; height: auto; }
            .admin-content { padding: 20px; }
            .modal__content { padding: 0; }
            .modal__text-content { padding: 20px; }
            .modal__content h2 { font-size: 2rem; }
            .modal__close { left: 20px; bottom: 20px; }
        }
        @media (max-width: 480px) {
            main { padding: 60px 15px; }
            section { margin-bottom: 60px; }
            .hero h1 { font-size: 2rem; }
            .nav-menu { padding: 80px 20px; }
            .nav-menu a { font-size: 1.5rem; }
            .modal__close { left: 15px; bottom: 15px; }
        }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <canvas id="webgl-canvas"></canvas>

    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>

    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#contact">Contact</a></li>
            <li><a href="#" id="admin-toggle">Admin</a></li>
        </ul>
    </div>

    <main>
        <section id="hero" class="hero"></section>
        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
    </main>

    <div id="modal-container"></div>

    <div id="admin-panel">
        <div class="admin-container">
            <div class="admin-sidebar">
                <h3>Admin Panel</h3>
                <ul class="admin-tabs">
                    <li class="admin-tab active" data-tab="home">Home</li>
                    <li class="admin-tab" data-tab="services">Services</li>
                    <li class="admin-tab" data-tab="portfolio">Portfolio</li>
                    <li class="admin-tab" data-tab="blog">Blog</li>
                </ul>
            </div>
            <div class="admin-content">
                <button id="admin-close-btn" title="Close Admin Panel">&times;</button>
                <div class="tab-content active" data-tab-content="home"></div>
                <div class="tab-content" data-tab-content="services"></div>
                <div class="tab-content" data-tab-content="portfolio"></div>
                <div class="tab-content" data-tab-content="blog"></div>
            </div>
        </div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>

    <script type="module">
        import * as THREE from 'three';

        // =================================================================================
        // CRITICAL NOTE: For video playback (YouTube/Vimeo) to work, this HTML file
        // MUST be served by a web server (e.g., http://localhost:5500), not opened
        // directly as a file (file:///...).
        // The easiest way is to use the "Live Server" extension in VS Code.
        // =================================================================================
        
        const initialSiteData = {
            home: {
                title: "Crafting Digital Excellence",
                subtitle: "We create bespoke websites that elevate small businesses through elegant design and cutting-edge technology.",
                cta: "Start Your Project"
            },
            services: [
                {
                    id: 'service-1', title: 'Web Development', subtitle: 'From Landing Pages to E-Commerce',
                    description: 'We build fast, responsive, and secure websites tailored to your needs.',
                    modalContent: 'Our development process focuses on clean code, performance, and scalability. We use modern technologies to ensure your site stands the test of time. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.',
                    media: ['https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=2070&auto=format&fit=crop', 'https://www.youtube.com/watch?v=Qdeot_p_B8s']
                }
            ],
            portfolio: [
                {
                    id: 'portfolio-1', title: 'Project Alpha', subtitle: 'Corporate Website',
                    description: 'A sleek, modern website for a leading tech consultant.',
                    modalContent: 'This project involved a complete redesign focusing on lead generation and clear communication of complex services. The result was a 40% increase in user engagement. Vivamus vestibulum ntulla nec ante. Praesent placerat. Fusce wisi. Phasellus faucibus molestie nisl. Fusce ac felis sit amet ligula pharetra condimentum. Maecenas egestas, ante et consectetur egestas, lectus est congue tellus, non mattis eros augue et magna.',
                    media: ['https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=2070&auto=format&fit=crop']
                },
                 {
                    id: 'portfolio-2', title: 'Project Beta', subtitle: 'E-Commerce Store',
                    description: 'An elegant online store for a boutique fashion brand.',
                    modalContent: 'We built a custom Shopify theme to reflect the brand\'s unique aesthetic, integrating features for a seamless shopping experience. The platform is robust, scalable, and easy for the client to manage, resulting in a significant uplift in online sales and customer satisfaction.',
                    media: ['https://images.unsplash.com/photo-1522204523234-8729aa6e3d5f?q=80&w=2070&auto=format&fit=crop', 'https://vimeo.com/394422933']
                }
            ],
            blog: [
                {
                    id: 'article1', title: '10 Principles of Effective Web Design', subtitle: 'June 15, 2023',
                    description: 'Discover the fundamental principles that make websites both beautiful and functional.',
                    modalContent: 'Теперь контент "парит" в воздухе над фоном. Главная страница исчезает. Каждый элемент появляется с анимацией. The quick brown fox jumps over the lazy dog. The five boxing wizards jump quickly. Pack my box with five dozen liquor jugs. When zombies arrive, quickly fax judge Pat. Heavy boxes perform quick waltzes and jigs.',
                    media: ['https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=2070&auto=format&fit=crop', 'https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=2070&auto=format&fit=crop']
                },
                {
                    id: 'article2', title: 'SEO Strategies for Small Businesses', subtitle: 'May 28, 2023',
                    description: 'Learn how to improve your online visibility without breaking the bank.',
                    modalContent: 'Это модальное окно полностью соответствует изначальному запросу.',
                    media: ['https://www.youtube.com/watch?v=668nUCeBHyY']
                }
            ]
        };
        
        // --- State and Core Variables ---
        let siteData = {};
        let activeSlideshow = null;
        let slideshowIntervals = [];

        // --- API Promises ---
        const sleep = ms => new Promise(res => setTimeout(res, ms));
        const youtubeApiReady = new Promise(resolve => { window.onYouTubeIframeAPIReady = () => resolve(); });
        const vimeoApiReady = new Promise(resolve => {
            const interval = setInterval(() => { if (window.Vimeo) { clearInterval(interval); resolve(); } }, 100);
        });

        // --- Data Management ---
        const saveData = () => localStorage.setItem('siteData', JSON.stringify(siteData));
        const loadData = () => {
            const storedData = localStorage.getItem('siteData');
            siteData = storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(initialSiteData));
        };

        // --- Master UI Rebuild Function ---
        function rebuildUI() {
            // a. Remember active tab
            const activeTabKey = document.querySelector('.admin-tabs .active')?.dataset.tab || 'home';
            // b. Save data to localStorage
            saveData();
            // c. Re-render all dynamic public content
            renderAllContent();
            // d. Re-render the entire admin panel
            renderAdminPanel();
            
            // e. Restore the active admin tab
            document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`.admin-tab[data-tab="${activeTabKey}"]`)?.classList.add('active');
            document.querySelector(`.tab-content[data-tab-content="${activeTabKey}"]`)?.classList.add('active');

            // f. Re-initialize static listeners for the new DOM
            initStaticEventListeners();
        }
        
        // --- Rendering Functions ---
        function renderAllContent() {
            renderHero();
            renderSection('services', 'Our Services', siteData.services);
            renderSection('portfolio', 'Our Work', siteData.portfolio);
            renderSection('blog', 'Latest Insights', siteData.blog);
            renderModals();
            initIntersectionObservers();
        }

        function renderHero() {
            const heroSection = document.getElementById('hero');
            if (!heroSection) return;
            const { title, subtitle, cta } = siteData.home;
            heroSection.innerHTML = `
                <h1 class="animated-container animated-text">${title}</h1>
                <p class="animated-container animated-text">${subtitle}</p>
                <a href="#contact" class="cta-button animated-container">${cta}</a>`;
        }

        function renderSection(id, title, items) {
            const section = document.getElementById(id);
            if (!section) return;
            const itemsHTML = items.map(item => {
                const imageMedia = item.media.filter(url => !/youtube|vimeo/.test(url));
                const firstImage = imageMedia[0];
                const imageStyle = firstImage ? `style="background-image: url('${firstImage}')"` : '';
                return `
                <article class="item-card animated-container" data-modal-id="${item.id}">
                    <div class="item-card__image" ${imageStyle} data-media-images="${imageMedia.join(',')}"></div>
                    <div class="item-card__content">
                        <h3 class="animated-text">${item.title}</h3>
                        <div class="card-subtitle animated-text">${item.subtitle}</div>
                        <p class="animated-text">${item.description}</p>
                    </div>
                </article>`;
            }).join('');
            section.innerHTML = `
                <div class="animated-container"><h2 class="animated-text">${title}</h2></div>
                <div class="item-grid">${itemsHTML}</div>`;
            initCardSlideshows(section);
        }

        function renderModals() {
            const container = document.getElementById('modal-container');
            if (!container) return;
            const allItems = [...siteData.services, ...siteData.portfolio, ...siteData.blog];
            
            const getEmbedUrl = (url) => {
                let videoId;
                const origin = window.location.origin && window.location.origin !== 'null' ? window.location.origin : 'http://localhost';
                if (url.includes('youtube.com/watch?v=')) videoId = new URL(url).searchParams.get('v');
                else if (url.includes('youtu.be/')) videoId = new URL(url).pathname.substring(1);
                else if (url.includes('youtube.com/embed/')) videoId = url.split('/embed/')[1].split('?')[0];
                if (videoId) return `https://www.youtube.com/embed/${videoId}?enablejsapi=1&controls=0&loop=1&playlist=${videoId}&mute=1&origin=${origin}`;
                if (url.includes('vimeo.com/')) {
                    videoId = url.split('vimeo.com/')[1].split('?')[0];
                    return `https://player.vimeo.com/video/${videoId}?loop=1&muted=1&dnt=1`;
                }
                return null;
            };

            container.innerHTML = allItems.map(item => {
                const mediaHTML = item.media.map((url, index) => {
                    const embedUrl = getEmbedUrl(url);
                    const iframeId = `player-${item.id}-${index}`;
                    if (embedUrl) return `<div class="media-item" data-type="video"><iframe id="${iframeId}" data-src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                    return `<div class="media-item" data-type="image"><img src="${url}" alt="${item.title}"></div>`;
                }).join('');

                return `
                <div class="modal" id="${item.id}">
                    <div class="modal__content">
                        <button class="modal__close"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
                        ${item.media.length > 0 ? `<div class="modal__media-viewer">${mediaHTML}</div>` : ''}
                        <div class="modal__text-content">
                            <h2 class="animated-text">${item.title}</h2>
                            <p class="animated-text">${item.modalContent}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
            initModalEventListeners();
        }

        function renderAdminPanel() {
            renderAdminHome();
            renderAdminSection('services');
            renderAdminSection('portfolio');
            renderAdminSection('blog');
        }

        function renderAdminHome() {
            const container = document.querySelector('.tab-content[data-tab-content="home"]');
            if (!container) return;
            container.innerHTML = `
                <div class="admin-section-header"><h2>Home Page Content</h2></div>
                <div class="admin-item" id="admin-home-item">
                    <div class="admin-item-content">
                        <label for="home-title">Title</label><input type="text" id="home-title" value="${siteData.home.title}" disabled>
                        <label for="home-subtitle">Subtitle</label><textarea id="home-subtitle" rows="4" disabled>${siteData.home.subtitle}</textarea>
                        <label for="home-cta">CTA Button Text</label><input type="text" id="home-cta" value="${siteData.home.cta}" disabled>
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit-home">Edit</button>
                        <button class="admin-btn save-btn" data-action="save-home">Save</button>
                    </div>
                </div>`;
        }

        function renderAdminSection(key) {
            const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`);
            if (!container) return;
            const title = key.charAt(0).toUpperCase() + key.slice(1);
            const itemsHTML = siteData[key].map(item => `
                <div class="admin-item" data-id="${item.id}" data-key="${key}">
                    <div class="admin-item-content">
                        <label>Title</label><input type="text" class="admin-input-title" value="${item.title}" disabled>
                        <label>Subtitle / Date</label><input type="text" class="admin-input-subtitle" value="${item.subtitle}" disabled>
                        <label>Card Description</label><textarea class="admin-input-description" rows="3" disabled>${item.description}</textarea>
                        <label>Modal Content</label><textarea class="admin-input-modalContent" rows="5" disabled>${item.modalContent}</textarea>
                        <label>Modal Media (Image/YouTube/Vimeo URLs, one per line)</label><textarea class="admin-input-media" rows="4" disabled>${item.media.join('\n')}</textarea>
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit">Edit</button>
                        <button class="admin-btn save-btn" data-action="save">Save</button>
                        <button class="admin-btn delete-btn" data-action="delete">Delete</button>
                    </div>
                </div>`).join('');
            container.innerHTML = `<div class="admin-section-header"><h2>Manage ${title}</h2><button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button></div>${itemsHTML}`;
        }

        // --- Event Listener Initialization ---
        function initStaticEventListeners() {
            document.querySelector('.menu-toggle')?.addEventListener('click', e => {
                e.currentTarget.classList.toggle('is-active');
                document.querySelector('.nav-overlay')?.classList.toggle('is-active');
                document.body.classList.toggle('nav-is-open');
            });

            document.querySelectorAll('.nav-menu a:not(#admin-toggle)').forEach(link => {
                link.addEventListener('click', () => {
                    document.querySelector('.menu-toggle')?.classList.remove('is-active');
                    document.querySelector('.nav-overlay')?.classList.remove('is-active');
                    document.body.classList.remove('nav-is-open');
                });
            });

            document.getElementById('admin-toggle')?.addEventListener('click', e => { e.preventDefault(); document.getElementById('admin-panel').classList.add('active'); });
            document.getElementById('admin-close-btn')?.addEventListener('click', () => document.getElementById('admin-panel').classList.remove('active'));
            document.querySelector('.admin-tabs')?.addEventListener('click', e => {
                if (e.target.matches('.admin-tab')) {
                    document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelector(`.tab-content[data-tab-content="${e.target.dataset.tab}"]`)?.classList.add('active');
                }
            });

            document.querySelector('.admin-content')?.addEventListener('click', handleAdminActions);
            document.querySelector('main')?.addEventListener('click', e => {
                const card = e.target.closest('.item-card');
                if (card) {
                    const modal = document.getElementById(card.dataset.modalId);
                    if (modal) {
                        document.body.classList.add('modal-is-open');
                        modal.classList.add('is-active');
                        initializeModalSlideshow(modal);
                    }
                }
            });
        }
        
        function initModalEventListeners() {
            const closeModal = (modal) => {
                modal.classList.remove('is-active');
                document.body.classList.remove('modal-is-open');
                if (activeSlideshow && activeSlideshow.clear) {
                    activeSlideshow.clear();
                    activeSlideshow = null;
                }
                const content = modal.querySelector('.modal__content');
                if (content) content.scrollTop = 0;
            };
            document.querySelectorAll('.modal').forEach(modal => {
                modal.querySelector('.modal__close')?.addEventListener('click', () => closeModal(modal));
                modal.addEventListener('click', e => { if (e.target === modal) closeModal(modal); });
            });
            window.addEventListener('keydown', e => {
                if (e.key === "Escape") {
                    const activeModal = document.querySelector('.modal.is-active');
                    if (activeModal) closeModal(activeModal);
                }
            });
        }
        
        // --- Event Handlers ---
        function handleAdminActions(e) {
            const target = e.target;
            const action = target.dataset.action;
            if (!action) return;

            const itemEl = target.closest('.admin-item');
            
            // MANDATE 1: Home section logic. The 'edit' part modifies local DOM state.
            // The 'save' part MUST trigger a full rebuild.
            if (action === 'edit-home' || action === 'save-home') {
                const isEditing = itemEl.classList.contains('is-editing');
                itemEl.classList.toggle('is-editing', !isEditing);
                itemEl.querySelectorAll('input, textarea').forEach(input => input.disabled = isEditing);
                
                if (action === 'save-home') {
                    // Update the central state
                    siteData.home = {
                        title: itemEl.querySelector('#home-title').value,
                        subtitle: itemEl.querySelector('#home-subtitle').value,
                        cta: itemEl.querySelector('#home-cta').value
                    };
                    // Trigger the master rebuild function, which handles saving and re-rendering
                    rebuildUI();
                }
                return;
            }

            const key = target.dataset.key || itemEl.dataset.key;
            const id = itemEl ? itemEl.dataset.id : null;

            switch(action) {
                case 'edit':
                    itemEl.classList.add('is-editing');
                    itemEl.querySelectorAll('input, textarea').forEach(input => input.disabled = false);
                    break;
                case 'save': {
                    const itemData = siteData[key].find(item => item.id === id);
                    if (itemData) {
                        itemData.title = itemEl.querySelector('.admin-input-title').value;
                        itemData.subtitle = itemEl.querySelector('.admin-input-subtitle').value;
                        itemData.description = itemEl.querySelector('.admin-input-description').value;
                        itemData.modalContent = itemEl.querySelector('.admin-input-modalContent').value;
                        itemData.media = itemEl.querySelector('.admin-input-media').value.split('\n').map(s => s.trim()).filter(Boolean);
                    }
                    rebuildUI();
                    break;
                }
                case 'delete':
                    if (confirm('Are you sure?')) {
                        siteData[key] = siteData[key].filter(item => item.id !== id);
                        rebuildUI();
                    }
                    break;
                case 'add':
                    siteData[key].push({ id: `${key}-${Date.now()}`, title: 'New Item', subtitle: 'New Subtitle', description: 'New description.', modalContent: 'New modal content.', media: [] });
                    rebuildUI();
                    break;
            }
        }

        function initCardSlideshows(section) {
            slideshowIntervals.forEach(clearInterval);
            slideshowIntervals = [];

            section.querySelectorAll('.item-card__image').forEach(imageEl => {
                const media = imageEl.dataset.mediaImages.split(',').filter(Boolean);
                if (media.length > 1) {
                    let currentIndex = 0;
                    const intervalId = setInterval(() => {
                        imageEl.style.opacity = 0;
                        setTimeout(() => {
                            currentIndex = (currentIndex + 1) % media.length;
                            imageEl.style.backgroundImage = `url('${media[currentIndex]}')`;
                            imageEl.style.opacity = 1;
                        }, 500);
                    }, 5000);
                    slideshowIntervals.push(intervalId);
                }
            });
        }
        
        // MANDATE 3: Re-architected modal slideshow logic
        async function initializeModalSlideshow(modal) {
            if (activeSlideshow?.clear) activeSlideshow.clear();

            const mediaViewer = modal.querySelector('.modal__media-viewer');
            const mediaItems = Array.from(modal.querySelectorAll('.media-item'));
            if (!mediaViewer || mediaItems.length === 0) return;

            await Promise.all([youtubeApiReady, vimeoApiReady]);

            // The single state object to manage the slideshow's lifecycle
            const state = {
                currentIndex: -1,
                players: {},
                savedTimestamps: {},
                isTransitioning: false,
                isCleared: false,
                timerId: null,
                touchStartX: 0,
            };

            // The core state-machine function for transitions
            const transitionToSlide = async (newIndex) => {
                if (state.isTransitioning || state.isCleared) return; // Entry Guard
                state.isTransitioning = true; // Master Lock
                
                try {
                    clearTimeout(state.timerId);

                    await pauseAndSaveCurrentPlayer();
                    if (mediaItems[state.currentIndex]) {
                        mediaItems[state.currentIndex].classList.remove('is-active');
                    }

                    await sleep(500); // Wait for fade-out animation
                    if (state.isCleared) return; // Exit if modal closed during transition

                    await sleep(200); // Mandatory pause with visible background
                    if (state.isCleared) return; // Exit again
                    
                    destroyPlayer(state.currentIndex);
                    
                    state.currentIndex = newIndex;
                    const newItem = mediaItems[state.currentIndex];
                    newItem.classList.add('is-active');

                    if (newItem.dataset.type === 'video') {
                        await createAndPlayNewPlayer(state.currentIndex);
                    }
                    
                    if (!state.isCleared && mediaItems.length > 1) {
                        state.timerId = setTimeout(() => {
                            transitionToSlide((state.currentIndex + 1) % mediaItems.length);
                        }, 3000); // 3-second delay as mandated
                    }
                } finally {
                    state.isTransitioning = false; // Unlock, always
                }
            };

            const pauseAndSaveCurrentPlayer = async () => {
                const player = state.players[state.currentIndex];
                if (!player) return;
                try {
                    if (player.getPlayerState) { // YouTube API
                        if ([1, 3].includes(player.getPlayerState())) {
                            state.savedTimestamps[state.currentIndex] = await player.getCurrentTime();
                            player.pauseVideo();
                        }
                    } else if (player.getPaused) { // Vimeo API
                        const isPaused = await player.getPaused();
                        if (!isPaused) {
                            state.savedTimestamps[state.currentIndex] = await player.getCurrentTime();
                            await player.pause();
                        }
                    }
                } catch(e) { console.error("Error pausing video", e); }
            };

            const destroyPlayer = (index) => {
                const player = state.players[index];
                if (player?.destroy) player.destroy();
                delete state.players[index];
            };

            const createAndPlayNewPlayer = (index) => new Promise(resolve => {
                const item = mediaItems[index];
                const iframe = item.querySelector('iframe');
                if (!iframe) return resolve();
                if (iframe.dataset.src && !iframe.src) iframe.src = iframe.dataset.src;

                if (iframe.src.includes('youtube')) {
                    state.players[index] = new YT.Player(iframe.id, {
                        events: {
                            'onReady': e => {
                                if (state.isCleared) return;
                                e.target.seekTo(state.savedTimestamps[index] || 0, true);
                                e.target.playVideo();
                                resolve();
                            },
                            'onStateChange': e => { if (e.data === 0) e.target.seekTo(0); },
                        }
                    });
                } else if (iframe.src.includes('vimeo')) {
                    const player = new Vimeo.Player(iframe);
                    state.players[index] = player;
                    player.ready().then(() => {
                        if(state.isCleared) return;
                        player.setCurrentTime(state.savedTimestamps[index] || 0).finally(resolve);
                        player.play();
                        player.on('ended', () => player.setCurrentTime(0));
                    });
                } else {
                    resolve();
                }
            });

            const clear = () => {
                state.isCleared = true;
                clearTimeout(state.timerId);
                mediaViewer.removeEventListener('touchstart', handleTouchStart);
                mediaViewer.removeEventListener('touchend', handleTouchEnd);
                Object.keys(state.players).forEach(destroyPlayer);
            };
            activeSlideshow = { clear };

            const handleTouchStart = e => { state.touchStartX = e.touches[0].clientX; };
            const handleTouchEnd = e => {
                const deltaX = e.changedTouches[0].clientX - state.touchStartX;
                if (Math.abs(deltaX) > 50) { // Swipe detected
                    transitionToSlide(deltaX < 0 ? (state.currentIndex + 1) % mediaItems.length : (state.currentIndex - 1 + mediaItems.length) % mediaItems.length);
                }
            };
            
            if (mediaItems.length > 1) {
                mediaViewer.addEventListener('touchstart', handleTouchStart, { passive: true });
                mediaViewer.addEventListener('touchend', handleTouchEnd, { passive: true });
            }

            transitionToSlide(0);
        }

        // --- Animation Functions ---
        function animateTextLetters(element) {
            if (!element || element.dataset.animated) return;
            element.dataset.animated = true;
            element.classList.add('is-animating');
            const text = element.textContent.trim();
            element.innerHTML = '';
            const words = text.split(/\s+/);
            words.forEach((word, wordIndex) => {
                const wordWrapper = document.createElement('span');
                wordWrapper.style.display = 'inline-block';
                word.split('').forEach((char) => {
                    const span = document.createElement('span');
                    span.textContent = char;
                    span.style.animationDelay = `${Math.random() * 0.5}s`;
                    wordWrapper.appendChild(span);
                });
                element.appendChild(wordWrapper);
                if (wordIndex < words.length - 1) {
                    element.appendChild(document.createTextNode(' '));
                }
            });
        }

        function activateContainer(container) {
            if (container.classList.contains('active')) return;
            container.classList.add('active');
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReducedMotion) {
                container.querySelectorAll('.animated-text').forEach(animateTextLetters);
                return;
            }
            setTimeout(() => {
                if (container.classList.contains('animated-text')) {
                    animateTextLetters(container);
                } else {
                    container.querySelectorAll('.animated-text').forEach(animateTextLetters);
                }
            }, 300);
        }
        
        let observer;
        function initIntersectionObservers() {
             if (observer) observer.disconnect();
             observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = entry.target;
                        const containers = section.querySelectorAll('.animated-container');
                        containers.forEach((container, index) => {
                            setTimeout(() => {
                                activateContainer(container);
                            }, index * 150);
                        });
                        obs.unobserve(section);
                    }
                });
            }, { threshold: 0.4 });
            document.querySelectorAll("main > section").forEach(section => {
                observer.observe(section);
            });
        }

        // --- Three.js Background ---
        let crystalMaterial;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        const canvas = document.getElementById("webgl-canvas");
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const pointLight1 = new THREE.PointLight(0x00aaff, 30, 20);
        pointLight1.position.set(5, 5, 5);
        scene.add(pointLight1);
        const crystalGroup = new THREE.Group();
        scene.add(crystalGroup);
        crystalMaterial = new THREE.ShaderMaterial({
            uniforms: { time: { value: 0 }, color1: { value: new THREE.Color(0xb8d8e8) }, color2: { value: new THREE.Color(0x1d2a3a) }, },
            vertexShader: `varying vec3 vNormal; varying vec3 vPosition; void main() { vNormal = normalize(normalMatrix * normal); vPosition = position; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform float time; uniform vec3 color1; uniform vec3 color2; varying vec3 vNormal; float snoise(vec3 v){ const vec2 C = vec2(1.0/6.0, 1.0/3.0) ; const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy) ); vec3 x0 = v - i + dot(i, C.xxx) ; vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min( g.xyz, l.zxy ); vec3 i2 = max( g.xyz, l.zxy ); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod(i, 289.0); vec4 p = mod(((i.z + vec4(0.0, i1.z, i2.z, 1.0 ))*34.0+1.0)* (i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 ), 289.0); p = mod(((p)*34.0+1.0)*(p) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ), 289.0); vec4 j = p - 49.0 * floor(p * (1.0/7.0) * (1.0/7.0)); vec4 x_ = floor(j * (1.0/7.0)); vec4 y_ = floor(j - 7.0 * x_ ); vec4 x = x_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 y = y_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4( x.xy, y.xy ); vec4 b1 = vec4( x.zw, y.zw ); vec4 s0 = floor(b0)*2.0 + 1.0; vec4 s1 = floor(b1)*2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ; vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ; vec3 p0 = vec3(a0.xy,h.x); vec3 p1 = vec3(a0.zw,h.y); vec3 p2 = vec3(a1.xy,h.z); vec3 p3 = vec3(a1.zw,h.w); vec4 norm = inversesqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0); m = m * m; return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) ); } void main() { float noise = snoise(vNormal * 3.0 + time * 0.1); vec3 baseColor = mix(color1, color2, vNormal.y * 0.5 + 0.5); float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 3.0); vec3 finalColor = baseColor + fresnel * vec3(0.8, 0.9, 1.0) * 0.5; finalColor += noise * 0.2; gl_FragColor = vec4(finalColor, fresnel * 0.8 + 0.2); }`,
            transparent: true, blending: THREE.AdditiveBlending, depthWrite: false,
        });
        const coreCrystal = new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 1), crystalMaterial);
        crystalGroup.add(coreCrystal);
        let branches = [];
        let crystalGrowth = 0;
        const addBranch = () => {
            if (branches.length > 50) return;
            const branch = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1 + Math.random() * 0.4, 0), crystalMaterial);
            const phi = Math.random() * Math.PI * 2, theta = Math.acos(Math.random() * 2 - 1), radius = 1 + Math.random() * crystalGrowth;
            branch.position.set( radius * Math.sin(theta) * Math.cos(phi), radius * Math.sin(theta) * Math.sin(phi), radius * Math.cos(theta) );
            branch.rotation.set(Math.random(), Math.random(), Math.random());
            branch.scale.set(0.01, 0.01, 0.01);
            crystalGroup.add(branch);
            branches.push({ mesh: branch, life: 0, maxLife: 0.5 + Math.random() * 1.5 });
        };
        const clock = new THREE.Clock();
        let scrollFraction = 0, introComplete = false;
        const introDuration = 5;
        function animate() {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();
            if (crystalMaterial) crystalMaterial.uniforms.time.value = elapsedTime;
            let introProgress = introComplete ? 1.0 : Math.min(elapsedTime / introDuration, 1.0);
            if (introProgress >= 1.0) introComplete = true;
            crystalGrowth = Math.max(introProgress * 1.5, Math.min(scrollFraction * 5, 2.5));
            if (crystalGrowth > 0.1 && Math.random() > 0.9) addBranch();
            camera.position.z = 5 - Math.max(introProgress * 1.0, scrollFraction * 2);
            camera.position.y = scrollFraction * 1;
            camera.lookAt(scene.position);
            crystalGroup.rotation.y += 0.001;
            crystalGroup.rotation.x += 0.0005;
            coreCrystal.scale.setScalar(1 + crystalGrowth * 0.5);
            branches.forEach(b => { if (b.life < b.maxLife) { b.life += 0.01; b.mesh.scale.setScalar(Math.sin(b.life / b.maxLife * Math.PI * 0.5)); } });
            renderer.render(scene, camera);
        }

        // --- Initial Load ---
        window.addEventListener('load', () => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            loadData();
            rebuildUI(); // Use the master function for initial setup
            animate();
        });

        window.addEventListener("scroll", () => {
            const scrollableHeight = document.body.scrollHeight - window.innerHeight;
            scrollFraction = scrollableHeight > 0 ? window.scrollY / scrollableHeight : 0;
        });
        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>