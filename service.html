<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO-теги будут вставлены здесь динамически -->
    <title>Loading Service...</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Полные стили, скопированные из вашего рабочего index.html */
        :root { --color-bg: #030409; --color-text: #FFFFFF; --color-accent: #b8d8e8; --color-card: rgba(25, 29, 45, 0.4); --color-border: rgba(184, 216, 232, 0.2); --font-main: 'Inter', sans-serif; }
        body { margin: 0; padding: 0; font-family: var(--font-main); background-color: var(--color-bg); color: var(--color-text); -webkit-font-smoothing: antialiased; overflow-x: hidden; line-height: 1.6; }
        body.nav-is-open { overflow: hidden; }
        h1, h2, h3, h4 { font-weight: 600; letter-spacing: 0.5px; }
        h2 { font-size: clamp(1.8rem, 1.5rem + 1.5vw, 2.5rem); }
        a { color: var(--color-accent); text-decoration: none; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-out; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--color-accent); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #custom-background-iframe { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; border: none; z-index: 0; display: none; }
        main { position: relative; z-index: 2; max-width: 1200px; margin: 0 auto; padding: 100px 30px; }
        .menu-toggle { position: fixed; top: 30px; right: 30px; z-index: 1000; background: transparent; border: none; padding: 0; cursor: pointer; width: 30px; height: 24px; display: flex; flex-direction: column; justify-content: space-between; }
        .menu-toggle .bar { background: #FFFFFF; height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        .nav-overlay { position: fixed; top: 0; right: -100%; width: 400px; height: 100vh; background: var(--color-card); backdrop-filter: blur(10px); z-index: 999; transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; margin: 0; }
        .nav-menu li { margin-bottom: 25px; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; }
        .site-footer { position: relative; z-index: 2; text-align: center; padding: 40px 30px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.5); }
        .detail-page-header { text-align: left; margin-bottom: 60px; }
        .detail-page-header h1 { font-size: clamp(2.2rem, 5vw, 3.5rem); margin: 0 0 20px; line-height: 1.2; }
        .detail-price { font-size: 1.3rem; color: var(--color-accent); letter-spacing: 1px; }
        .detail-content { font-size: clamp(1.1rem, 1rem + 0.5vw, 1.25rem); opacity: 0.95; max-width: 800px; }
        .detail-content p, .detail-content li { margin-bottom: 1.5em; }
        .detail-content b, .detail-content strong { color: var(--color-accent); font-weight: 600; }
        .detail-content a { text-decoration: underline; }
        .embedded-video { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1.5em 0; border-radius: 8px; }
        .embedded-video iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #related-posts { margin-top: 120px; border-top: 1px solid var(--color-border); padding-top: 80px; }
        #related-posts h2 { text-align: center; margin-bottom: 40px; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .item-card { display: flex; flex-direction: column; background: var(--color-card); border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .item-card:hover { transform: translateY(-5px); border-color: var(--color-accent); }
        .item-card__image { aspect-ratio: 4 / 3; background-size: cover; background-position: center; }
        .item-card__content { padding: 25px; }
        .item-card h3 { margin: 0 0 10px; font-size: 1.3rem; }
        .item-card p { margin: 0; font-size: 1rem; opacity: 0.8; }
        @media (max-width: 1024px) { .nav-overlay { width: 100%; } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <iframe id="custom-background-iframe" title="Custom Background"></iframe>

    <button class="menu-toggle" aria-label="Toggle menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="nav-overlay"><ul class="nav-menu"></ul></div>

    <main>
        <div class="detail-page-header"><h1>Loading Service...</h1></div>
    </main>
    
    <footer class="site-footer"></footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, limit } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4",
          authDomain: "razrabotka-b61bc.firebaseapp.com",
          projectId: "razrabotka-b61bc",
          storageBucket: "razrabotka-b61bc.firebasestorage.app",
          messagingSenderId: "394402564794",
          appId: "1:394402564794:web:f610ffb03e655c600c5083"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const isGitHubPages = window.location.hostname.includes('github.io');
        const repoName = isGitHubPages ? window.location.pathname.split('/')[1] || '' : '';
        const basePath = isGitHubPages ? `/${repoName}` : '';
        
        async function initPage() {
            const mainEl = document.querySelector('main');
            
            const pathParts = window.location.pathname.replace(basePath, '').split('/').filter(p => p);
            
            const lang = pathParts[0];
            const collectionName = pathParts[1];
            const slug = pathParts[2];

            if (!lang || !slug || collectionName !== 'services') {
                mainEl.innerHTML = `<h1>Error: Invalid URL</h1><p>The page address is incorrect. Please return to the <a href="${basePath || '/'}">home page</a>.</p>`;
                document.getElementById('loader').classList.add('hidden');
                renderMenu();
                renderFooter();
                return;
            }

            try {
                const q = query(collection(db, "services"), where("lang", "==", lang), where("urlSlug", "==", slug), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    mainEl.innerHTML = `<h1>404 - Service Not Found</h1><p>Sorry, we couldn't find this service.</p><p><a href="${basePath || '/'}">Return to Home Page</a></p>`;
                    document.title = "404 Not Found | Digital Craft";
                } else {
                    const itemDoc = querySnapshot.docs[0];
                    const item = { id: itemDoc.id, ...itemDoc.data() };
                    
                    updateMetaTags(item, collectionName);
                    applyCustomBackground(item);

                    mainEl.innerHTML = `
                        <div class="detail-page-header">
                            <h1>${item.h1 || item.title || ''}</h1>
                            ${item.price ? `<div class="detail-price">${item.price}</div>` : ''}
                        </div>
                        <section>
                            <div class="detail-content">${formatContentHtml(item.mainContent)}</div>
                        </section>
                    `;
                    
                    const relatedPostsHtml = await renderRelatedPosts(item.lang, item.id);
                    if (relatedPostsHtml) {
                        mainEl.insertAdjacentHTML('beforeend', relatedPostsHtml);
                    }
                }
            } catch (error) {
                console.error("Error fetching service:", error);
                mainEl.innerHTML = `<h1>Error Loading Page</h1><p>There was a problem connecting to the database. Please try again later.</p>`;
            } finally {
                renderMenu();
                renderFooter();
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function updateMetaTags(data, collectionName) {
            document.querySelectorAll('meta[name="description"], meta[property^="og:"], script[type="application/ld+json"], link[rel="canonical"]').forEach(el => el.remove());
            document.title = data.seoTitle || data.title || "Digital Craft Service";
            document.documentElement.lang = data.lang || 'en';

            const createMeta = (attr, key, value) => { if (value) { const meta = document.createElement('meta'); meta.setAttribute(attr, key); meta.content = value; document.head.appendChild(meta); } };
            createMeta('name', 'description', data.metaDescription);
            createMeta('property', 'og:title', data.ogTitle || data.seoTitle);
            createMeta('property', 'og:description', data.ogDescription || data.metaDescription);
            if (data.media && data.media[0]) createMeta('property', 'og:image', data.media[0]);
            
            const canonical = document.createElement('link');
            canonical.rel = 'canonical';
            canonical.href = `${window.location.origin}${basePath}/${data.lang}/${collectionName}/${data.urlSlug}`;
            document.head.appendChild(canonical);
            
            if (data.schemaJsonLd && typeof data.schemaJsonLd === 'object' && Object.keys(data.schemaJsonLd).length > 0) {
                const script = document.createElement('script');
                script.type = 'application/ld+json';
                script.textContent = JSON.stringify(data.schemaJsonLd);
                document.head.appendChild(script);
            }
        }

        function formatContentHtml(content) {
            if (!content) return '';
            const blocks = content.replace(/\r\n/g, '\n').split(/\n{2,}/);
            return blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';
                const youtubeRegex = /^https?:\/\/(?:www\.|m\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|shorts\/))([a-zA-Z0-9_-]{11}).*$/;
                const youtubeMatch = trimmedBlock.match(youtubeRegex);
                if (youtubeMatch && youtubeMatch[1]) {
                    return `<div class="embedded-video"><iframe src="https://www.youtube.com/embed/${youtubeMatch[1]}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                }
                return `<p>${trimmedBlock.replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }

        async function renderRelatedPosts(currentLang, currentId) {
            try {
                const q = query(collection(db, "services"), where("lang", "==", currentLang), where("__name__", "!=", currentId));
                const querySnapshot = await getDocs(q);
                
                const allItems = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const relatedItems = allItems.sort(() => 0.5 - Math.random()).slice(0, 3);

                if (relatedItems.length === 0) return '';

                const itemsHTML = relatedItems.map(item => {
                    const itemUrl = `${basePath}/${item.lang}/services/${item.urlSlug}`;
                    return `
                        <a href="${itemUrl}" class="item-card">
                            <div class="item-card__image" style="background-image: url('${(item.media && item.media[0]) || ''}')"></div>
                            <div class="item-card__content">
                                <h3>${item.title}</h3>
                                <p>${item.description || ''}</p>
                            </div>
                        </a>`;
                }).join('');
                return `<section id="related-posts"><h2>You Might Also Like</h2><div class="item-grid">${itemsHTML}</div></section>`;
            } catch (error) {
                console.error("Error fetching related posts:", error);
                return '';
            }
        }
        
        function renderMenu() {
            const menuEl = document.querySelector('.nav-menu');
            const menuToggle = document.querySelector('.menu-toggle');
            const navOverlay = document.querySelector('.nav-overlay');
            if (!menuEl || !menuToggle || !navOverlay) return;

            const homeUrl = basePath || '/';
            const menuItems = [ 
                { label: 'Home', href: `${homeUrl}` },
                { label: 'Services', href: `${homeUrl}#services` },
                { label: 'Portfolio', href: `${homeUrl}#portfolio` },
                { label: 'Blog', href: `${homeUrl}#blog` },
                { label: 'Contact', href: `${homeUrl}#contact` }
            ];
            menuEl.innerHTML = menuItems.map(item => `<li><a href="${item.href}">${item.label}</a></li>`).join('');
            
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                document.body.classList.toggle('nav-is-open');
                menuToggle.classList.toggle('is-active');
                navOverlay.classList.toggle('is-active');
            });
        }
        
        function renderFooter() {
            document.querySelector('.site-footer').innerHTML = `© ${new Date().getFullYear()} Digital Craft. All rights reserved.`;
        }
        
        function applyCustomBackground(item = {}) {
            const iframe = document.getElementById('custom-background-iframe');
            const customCode = item?.backgroundHtml || '';
            if (customCode.trim()) {
                iframe.style.display = 'block';
                iframe.srcdoc = customCode;
            } else {
                iframe.style.display = 'none';
                iframe.srcdoc = '';
            }
        }

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>